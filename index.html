<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Money Coach – Budget + Debt + Psychology</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  :root{
    --bg:#0d101f; --bg-glow:radial-gradient(circle at top,#1f2654 0%,rgba(13,16,31,0) 55%);
    --card:#171a2e; --card-glass:rgba(23,26,46,.82);
    --ink:#f3f5ff; --muted:#aab1d9; --accent:#7c9bff;
    --good:#38d39f; --warn:#ffb648; --bad:#ff6b6b; --line:#242845;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;min-height:100%}
  body::before{content:"";position:fixed;inset:0;background:var(--bg-glow);z-index:-1;opacity:.9}
  header{padding:24px 26px;border-bottom:1px solid rgba(124,155,255,.15);position:sticky;top:0;background:linear-gradient(180deg,rgba(15,18,33,.9) 0%,rgba(15,18,33,.65) 100%);backdrop-filter:blur(10px);z-index:5;box-shadow:0 12px 25px rgba(9,12,25,.25)}
  header h1{margin:0;font-size:20px;letter-spacing:.04em;font-weight:600}
  header .sub{color:var(--muted);font-size:13px;margin-top:6px}
  main{max-width:1160px;margin:32px auto;padding:0 20px 96px}

  .grid{display:grid;gap:16px}
  @media (min-width: 880px){
    .grid-2{grid-template-columns:1.2fr .8fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
  }

  .card{background:var(--card-glass);border:1px solid rgba(124,155,255,.12);border-radius:18px;padding:20px;box-shadow:0 18px 40px rgba(9,12,25,.35);backdrop-filter:blur(12px)}
  .card h2{margin:0 0 12px;font-size:17px;font-weight:600;display:flex;align-items:center;gap:10px}
  .card h2::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,rgba(124,155,255,.5),rgba(124,155,255,0));border-radius:999px}
  .card h3{margin:18px 0 8px;font-size:13px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.12em}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0}
  label{font-size:13px;color:var(--muted);min-width:150px;letter-spacing:.02em}
  input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(124,155,255,.2);background:rgba(10,13,28,.9);color:var(--ink);outline:none;transition:border .2s,box-shadow .2s,transform .2s}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,155,255,.18);transform:translateY(-1px)}
  textarea{min-height:80px;resize:vertical}
  .mono{font-variant-numeric:tabular-nums}
  .btn{border:1px solid rgba(124,155,255,.25);background:linear-gradient(135deg,rgba(15,22,46,.95),rgba(12,15,33,.85));color:var(--ink);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:500;transition:transform .2s,box-shadow .2s,border .2s}
  .btn:hover{border-color:rgba(124,155,255,.45);box-shadow:0 12px 22px rgba(9,12,25,.4);transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(135deg,#85a5ff,#6f8dff);border-color:rgba(133,165,255,.8);color:#0b0e1d;font-weight:600;box-shadow:0 18px 28px rgba(124,155,255,.3)}
  .btn.primary:hover{transform:translateY(-2px);box-shadow:0 22px 36px rgba(124,155,255,.38)}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid rgba(124,155,255,.25);font-size:12px;color:var(--muted);margin-right:6px;background:rgba(12,15,32,.7)}
  .kpi{display:flex;justify-content:space-between;gap:10px}
  .kpi .box{flex:1;background:linear-gradient(160deg,rgba(16,21,43,.92),rgba(11,14,27,.85));border:1px solid rgba(124,155,255,.18);border-radius:16px;padding:16px;box-shadow:0 16px 28px rgba(9,12,25,.3)}
  .kpi .box .label{color:var(--muted);font-size:11px;margin-bottom:8px;letter-spacing:.08em}
  .kpi .box .val{font-size:22px;font-weight:700}
  table{width:100%;border-collapse:collapse;border-radius:14px;overflow:hidden;background:rgba(12,15,32,.6)}
  thead{background:rgba(18,22,45,.9)}
  th,td{border-bottom:1px solid rgba(124,155,255,.12);padding:12px 10px;text-align:left;font-size:14px}
  tbody tr:hover{background:rgba(18,22,45,.55)}
  th{color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px}
  tfoot td{font-weight:700;background:rgba(18,22,45,.8)}
  .right{text-align:right}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .divider{height:1px;background:linear-gradient(90deg,rgba(124,155,255,.4),rgba(124,155,255,0));margin:14px 0}
  .tag{background:rgba(16,21,51,.8);border:1px solid rgba(39,48,107,.6);color:#dbe2ff;padding:4px 10px;border-radius:8px;font-size:11px;margin-right:6px;letter-spacing:.05em}
  details summary{cursor:pointer;color:#cfd6ff;transition:color .2s}
  details[open] summary{color:#ffffff}
  .flex{display:flex;gap:12px;align-items:center}
  .note{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.6}
  .caps{letter-spacing:.06em;text-transform:uppercase}
</style>
</head>
<body>
<header>
  <h1>Money Coach • Budget + Debt + Psychology</h1>
  <div class="sub">Zero-based plan • Debt Snowball/Avalanche • Habit tools • Family agreement</div>
</header>

<main class="grid grid-2">
  <!-- LEFT COLUMN -->
  <section class="grid">
    <!-- Income & Fixed -->
    <div class="card">
      <h2>1) Income & Fixed Costs</h2>
      <div class="row"><label>Monthly Net Income (€)</label><input id="income" type="number" class="mono" value="1400" min="0" step="1"></div>
      <h3>Fixed commitments</h3>
      <div class="row"><label>Loans (min total) (€)</label><input id="loans" type="number" class="mono" value="800" min="0" step="1"></div>
      <div class="row"><label>Mom contribution (€)</label><input id="mom" type="number" class="mono" value="85" min="0" step="1"></div>
      <div class="row"><label>Apartment support for sister (€)</label><input id="aptSupport" type="number" class="mono" value="140" min="0" step="1"></div>
      <div class="row"><label>Phone/Internet (€)</label><input id="phone" type="number" class="mono" value="30" min="0" step="1"></div>
      <div class="row"><label>Transport (€)</label><input id="transport" type="number" class="mono" value="60" min="0" step="1"></div>
      <div class="row"><label>Groceries/Food (€)</label><input id="groceries" type="number" class="mono" value="200" min="0" step="1"></div>
      <div class="row"><label>Other Essentials (€)</label><input id="otherEss" type="number" class="mono" value="0" min="0" step="1"></div>
      <div class="divider"></div>
      <h3>Discretionary</h3>
      <div class="row"><label>Entertainment (€)</label><input id="fun" type="number" class="mono" value="20" min="0" step="1"></div>
      <div class="row"><label>Clothes/Personal (€)</label><input id="personal" type="number" class="mono" value="10" min="0" step="1"></div>
      <div class="row"><label>Cannabis cap (€)</label><input id="zazaCap" type="number" class="mono" value="120" min="0" step="1"></div>

      <div class="divider"></div>
      <h3>Safety & Goals</h3>
      <div class="row"><label>Emergency Fund (target €)</label><input id="efTarget" type="number" class="mono" value="300" min="0" step="1"></div>
      <div class="row"><label>Current EF balance (€)</label><input id="efNow" type="number" class="mono" value="0" min="0" step="1"></div>

      <div class="divider"></div>
      <div class="kpi">
        <div class="box"><div class="label">Total Planned Outflows</div><div class="val mono" id="kpiOut">—</div></div>
        <div class="box"><div class="label">Leftover / Shortfall</div><div class="val mono" id="kpiLeft">—</div></div>
        <div class="box"><div class="label">Surplus Allocation</div><div class="val mono" id="kpiAlloc">—</div></div>
      </div>
      <div class="note">Aim for <span class="caps">Leftover = 0</span> by allocating surplus to Emergency Fund until target is reached, then to Extra Debt Payment.</div>
    </div>

    <!-- Cannabis calculator -->
    <div class="card">
      <h2>2) Cannabis Reality Check</h2>
      <div class="row"><label>Price per gram (€)</label><input id="pricePerGram" type="number" class="mono" value="10" min="0" step="0.1"></div>
      <div class="row"><label>Grams per week</label><input id="gramsPerWeek" type="number" class="mono" value="3" min="0" step="0.1"></div>
      <div class="row"><label>Monthly spend (auto) (€)</label><input id="zazaAuto" type="number" class="mono" value="—" disabled></div>
      <div class="row"><label>Reduce by (%)</label><input id="zazaCutPct" type="number" class="mono" value="25" min="0" max="100"></div>
      <div class="row"><button class="btn" id="applyCap">Set Cap & Move Savings → EF</button><span class="small" id="capMsg"></span></div>
      <p class="note">We estimate monthly as <span class="mono">price × grams/week × 4.3</span>. Savings from the cut are earmarked to the Emergency Fund automatically in the plan.</p>
    </div>

    <!-- Debt Planner -->
    <div class="card">
      <h2>3) Debt Snowball / Avalanche</h2>
      <div class="row">
        <label>Strategy</label>
        <select id="strategy">
          <option value="avalanche">Avalanche (highest APR first)</option>
          <option value="snowball">Snowball (smallest balance first)</option>
        </select>
      </div>
      <div class="row"><label>Extra payment (auto from surplus) (€)</label><input id="extraDebt" type="number" class="mono" value="0" min="0" step="1"></div>
      <div class="row"><button class="btn" id="addDebt">+ Add Debt</button> <button class="btn" id="exportDebtCsv">Export Debts CSV</button></div>
      <table id="debtsTbl">
        <thead>
          <tr>
            <th>Debt</th><th class="right">Balance (€)</th><th class="right">APR %</th><th class="right">Min (€)</th><th>Due (DD)</th><th>Notes</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td><strong>Totals</strong></td><td class="right mono" id="sumBal">0</td><td></td>
              <td class="right mono" id="sumMin">0</td><td></td><td></td><td></td></tr>
        </tfoot>
      </table>
      <div class="divider"></div>
      <button class="btn primary" id="simulate">Simulate Payoff</button>
      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="label">Time to Debt-Free</div><div class="val mono" id="kpiMonths">—</div></div>
        <div class="box"><div class="label">Total Interest (est.)</div><div class="val mono" id="kpiInterest">—</div></div>
        <div class="box"><div class="label">Earliest Payoff</div><div class="val mono" id="kpiFirstDone">—</div></div>
      </div>
      <p class="note">Sim uses monthly compounding at APR/12, pays all minimums, then directs <span class="mono">Extra</span> to the target per chosen strategy. When a debt is paid, its minimum “snowballs” to the next.</p>
    </div>
  </section>

  <!-- RIGHT COLUMN -->
  <section class="grid">
    <!-- Psychology Coach -->
    <div class="card">
      <h2>Psychology Coach</h2>
      <h3>Implementation intentions</h3>
      <textarea id="implIntents">If it's after 22:30 and I crave, I will make tea and do an 8-min stretch; if I still want it after, I’ll keep to my cap.</textarea>
      <h3>Urge-surfing timer (3 minutes)</h3>
      <div class="row">
        <button class="btn" id="startUrge">Start 3:00</button>
        <div id="urgeClock" class="pill mono">03:00</div>
      </div>
      <h3>Weekly Check-in (keep it 10 minutes)</h3>
      <ul class="small">
        <li>Log Actuals in the budget.</li>
        <li>Check cannabis envelope/sub-account.</li>
        <li>If overshooting, trim this week (not next month).</li>
        <li>Celebrate one win (e.g., “€40 → Emergency Fund”).</li>
      </ul>
      <h3>Boundary scripts</h3>
      <details open><summary>Open scripts</summary>
        <ul class="small">
          <li><strong>Payday:</strong> “Debts + mom + apartment get paid first; I live on what’s left.”</li>
          <li><strong>Shop:</strong> “My cap for today is €… ; if I hit it, I’m done.”</li>
          <li><strong>Friends:</strong> “Cutting back this month—I’m on a savings streak.”</li>
          <li><strong>Lenders:</strong> “I’m current but stretched. Any hardship or rate-reduction options?”</li>
        </ul>
      </details>
    </div>

    <!-- Family Agreement Planner -->
    <div class="card">
      <h2>Family Agreement Planner (Apartment)</h2>
      <div class="row"><label>Purpose</label><input id="famPurpose" value="Support apartment for sister & niece"></div>
      <div class="row"><label>Parties & Roles</label><input id="famParties" value="You (payer), Friend (owner/landlord), Sister (occupant)"></div>
      <div class="row"><label>Monthly Amount (€)</label><input id="famAmount" type="number" class="mono" value="140"></div>
      <div class="row"><label>Start Date</label><input id="famStart" type="date"></div>
      <div class="row"><label>Review</label><input id="famReview" value="Every 6 months"></div>
      <div class="row"><label>Duration/End</label><input id="famEnd" value="5–6 years remaining"></div>
      <div class="row"><label>If late</label><input id="famLate" value="Grace ___ days; then plan ___"></div>
      <div class="row"><label>Adjustments</label><input id="famAdj" value="Change only at review or with written agreement"></div>
      <div class="row"><label>Future options</label><textarea id="famNotes">Option A: You move in later (terms for utilities/repairs). Option B: Transfer/sell to sister—agree fair price and schedule.</textarea></div>
    </div>

    <!-- Data Tools -->
    <div class="card">
      <h2>Data & Tools</h2>
      <div class="row">
        <button class="btn" id="save">Save</button>
        <button class="btn" id="reset">Reset to Defaults</button>
      </div>
      <div class="row">
        <button class="btn" id="exportJson">Export JSON</button>
        <label style="min-width:auto">Import JSON</label>
        <input id="importJson" type="file" accept="application/json" />
      </div>
      <p class="small muted">Autosaves to your browser (localStorage). Export before switching devices or clearing history.</p>
    </div>

    <!-- Live Summary -->
    <div class="card">
      <h2>Live Summary</h2>
      <div id="liveSummary" class="small"></div>
    </div>
  </section>
</main>

<script>
  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const fmt = n => isFinite(n) ? (Number(n).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})) : '—';
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  const inputs = {
    income:      $("#income"),
    loans:       $("#loans"),
    mom:         $("#mom"),
    aptSupport:  $("#aptSupport"),
    phone:       $("#phone"),
    transport:   $("#transport"),
    groceries:   $("#groceries"),
    otherEss:    $("#otherEss"),
    fun:         $("#fun"),
    personal:    $("#personal"),
    zazaCap:     $("#zazaCap"),
    efTarget:    $("#efTarget"),
    efNow:       $("#efNow"),

    pricePerGram:$("#pricePerGram"),
    gramsPerWeek:$("#gramsPerWeek"),
    zazaAuto:    $("#zazaAuto"),
    zazaCutPct:  $("#zazaCutPct"),
    applyCap:    $("#applyCap"),

    strategy:    $("#strategy"),
    extraDebt:   $("#extraDebt"),
  };

  const kpis = {
    out:   $("#kpiOut"),
    left:  $("#kpiLeft"),
    alloc: $("#kpiAlloc"),
    months:$("#kpiMonths"),
    interest:$("#kpiInterest"),
    firstDone:$("#kpiFirstDone"),
  };

  const summary = $("#liveSummary");

  // ===== Budget Logic (Excel-like) =====
  function computeOutflows(){
    const essentials = (+inputs.loans.value||0)+(+inputs.mom.value||0)+(+inputs.aptSupport.value||0)
      +(+inputs.phone.value||0)+(+inputs.transport.value||0)+(+inputs.groceries.value||0)+(+inputs.otherEss.value||0);
    const discretionary = (+inputs.fun.value||0)+(+inputs.personal.value||0)+(+inputs.zazaCap.value||0);
    return essentials + discretionary;
  }

  function recomputeBudget(){
    const income = +inputs.income.value||0;
    const out = computeOutflows();
    const left = income - out;

    // Surplus allocation logic
    let toEF = 0, toDebt = 0;
    const efNeed = Math.max(0,(+inputs.efTarget.value||0) - (+inputs.efNow.value||0));
    if (left > 0){
      toEF = Math.min(left, efNeed);
      toDebt = Math.max(0, left - toEF);
    } else {
      toEF = 0; toDebt = 0;
    }

    // Reflect in KPIs
    kpis.out.textContent = "€ " + fmt(out);
    kpis.left.textContent = (left>=0? "€ " + fmt(left) : "€ -" + fmt(Math.abs(left)));
    kpis.left.className = "val mono " + (left>0 ? "good" : (left===0?"":"bad"));
    kpis.alloc.textContent = `EF € ${fmt(toEF)}  |  Extra Debt € ${fmt(toDebt)}`;

    // Feed extraDebt input for simulator
    inputs.extraDebt.value = Math.max(0,toDebt);

    // Live summary
    summary.innerHTML = `
      <div>Income: <strong>€ ${fmt(income)}</strong></div>
      <div>Outflows planned: <strong>€ ${fmt(out)}</strong></div>
      <div>Leftover: <strong class="${left>0?'good':(left===0?'':'bad')}">€ ${fmt(left)}</strong></div>
      <div>Allocation this month → Emergency Fund: <strong>€ ${fmt(toEF)}</strong>; Extra debt: <strong>€ ${fmt(toDebt)}</strong></div>
      <div class="divider"></div>
      <div class="small muted">Make Leftover = 0 by adjusting categories; surplus goes to EF until target is hit, then to debts.</div>
    `;
  }

  // ===== Cannabis calculator =====
  const capMsg = $("#capMsg");
  function recomputeZaza(){
    const monthly = (+inputs.pricePerGram.value||0) * (+inputs.gramsPerWeek.value||0) * 4.3;
    inputs.zazaAuto.value = (isFinite(monthly)? monthly.toFixed(0) : "—");
    return monthly;
  }
  inputs.applyCap.addEventListener("click", ()=>{
    const monthly = recomputeZaza();
    const cutPct = clamp(+inputs.zazaCutPct.value||0,0,100);
    const newCap = Math.round(monthly*(1-cutPct/100));
    const savings = Math.max(0, Math.round(monthly - newCap));
    inputs.zazaCap.value = newCap;
    // push savings to EF (not balance, but planned allocation)
    const efNeed = Math.max(0,(+inputs.efTarget.value||0)-(+inputs.efNow.value||0));
    capMsg.textContent = `Cap set to €${fmt(newCap)}. Planned savings €${fmt(savings)} earmarked to EF (need €${fmt(efNeed)}).`;
    recomputeBudget();
    persist();
  });

  // ===== Debt table =====
  const debtsTbl = $("#debtsTbl tbody");
  const sumBal = $("#sumBal");
  const sumMin = $("#sumMin");

  function addDebtRow(d={
    name:"Loan", balance:0, apr:0, min:0, due:"", notes:""
  }){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input value="${d.name||''}" /></td>
      <td class="right"><input type="number" class="mono" value="${d.balance||0}" step="1" min="0" /></td>
      <td class="right"><input type="number" class="mono" value="${d.apr||0}" step="0.1" min="0" /></td>
      <td class="right"><input type="number" class="mono" value="${d.min||0}" step="1" min="0" /></td>
      <td><input value="${d.due||''}" placeholder="DD" /></td>
      <td><input value="${d.notes||''}" /></td>
      <td><button class="btn">✕</button></td>
    `;
    // delete
    tr.querySelector("button").addEventListener("click", ()=>{ tr.remove(); updateDebtTotals(); persist(); });
    // re-compute on change
    tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", ()=>{ updateDebtTotals(); persist(); }));
    debtsTbl.appendChild(tr);
    updateDebtTotals();
  }

  function readDebts(){
    const rows = [...debtsTbl.querySelectorAll("tr")];
    return rows.map(r=>{
      const [name,balance,apr,min,due,notes] = [...r.querySelectorAll("input")].map(x=>x.value);
      return {name, balance:+balance||0, apr:+apr||0, min:+min||0, due, notes};
    });
  }

  function updateDebtTotals(){
    const debts = readDebts();
    const tBal = debts.reduce((a,b)=>a+b.balance,0);
    const tMin = debts.reduce((a,b)=>a+b.min,0);
    sumBal.textContent = fmt(tBal);
    sumMin.textContent = fmt(tMin);
  }

  $("#addDebt").addEventListener("click", ()=> addDebtRow());

  // Seed a couple of sample debts for clarity
  addDebtRow({name:"Card A", balance:1200, apr:19.9, min:50});
  addDebtRow({name:"Loan B", balance:2000, apr:9.5, min:70});

  // ===== Payoff simulator =====
  function simulatePayoff(){
    const debts = readDebts().filter(d=>d.balance>0).map(d=>({...d}));
    if (!debts.length){ kpis.months.textContent="—"; kpis.interest.textContent="—"; kpis.firstDone.textContent="—"; return; }

    let baseExtra = +inputs.extraDebt.value||0;
    let month=0, totalInterest=0, firstDone=null;

    // Sort helper
    function sortDebts(){
      if ($("#strategy").value==="avalanche"){
        debts.sort((a,b)=> b.apr - a.apr || a.balance - b.balance);
      } else {
        debts.sort((a,b)=> a.balance - b.balance || b.apr - a.apr);
      }
    }

    sortDebts();

    while (debts.some(d=>d.balance>0) && month<600){ // hard stop at 50 years
      month++;
      // monthly interest & minimums
      let extraPool = baseExtra;
      debts.forEach(d=>{
        if (d.balance<=0) return;
        const r = d.apr/100/12;
        const interest = d.balance*r;
        totalInterest += interest;
        d.balance += interest;
      });

      // pay minimums first
      debts.forEach(d=>{
        if (d.balance<=0) return;
        const pay = Math.min(d.min, d.balance);
        d.balance -= pay;
      });

      // remove/mark paid & snowball minimums into pool
      let freedMin = 0;
      debts.forEach(d=>{
        if (d.balance>0 && d.balance<0.01){ d.balance=0; }
        if (d.balance===0 && !d._doneMarked){
          d._doneMarked=true;
          freedMin += d.min;
          if (!firstDone) firstDone = {name:d.name, month};
        }
      });

      // add freed minimums to extra for this and future months
      extraPool += freedMin;
      baseExtra += freedMin;

      // pay extra to current target debt
      sortDebts();
      const target = debts.find(d=>d.balance>0);
      if (target){
        const pay = Math.min(extraPool, target.balance);
        target.balance -= pay;
      }

      // If target was fully paid by extra, mark and carry snowball next loop iteration
      debts.forEach(d=>{ if (d.balance>0 && d.balance<0.01){ d.balance=0; }});
      // Add freed minimums to their own min going forward (handled by freedMin above as extraPool increment each month)
    }

    const years = Math.floor(month/12), monthsRem = month%12;
    kpis.months.textContent = month? (years? `${years}y ${monthsRem}m`:`${month} m`) : "—";
    kpis.interest.textContent = "€ " + fmt(Math.round(totalInterest));
    kpis.firstDone.textContent = firstDone ? `${firstDone.name} in ${firstDone.month} m` : "—";
  }

  $("#simulate").addEventListener("click", simulatePayoff);

  // ===== Export / Import =====
  $("#exportDebtCsv").addEventListener("click", ()=>{
    const debts = readDebts();
    let csv = "Debt,Balance,APR,Min,Due,Notes\n";
    debts.forEach(d=>{
      csv += `"${d.name}",${d.balance},${d.apr},${d.min},"${d.due}","${(d.notes||'').replace(/"/g,'""')}"\n`;
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "debts.csv";
    a.click();
  });

  $("#exportJson").addEventListener("click", ()=>{
    const data = collectAll();
    const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "money-coach-data.json";
    a.click();
  });

  $("#importJson").addEventListener("change", async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      applyAll(data);
      persist();
    }catch(err){ alert("Invalid JSON"); }
  });

  // ===== Urge-surfing timer =====
  const startUrge = $("#startUrge");
  const urgeClock = $("#urgeClock");
  let urgeTimer = null;
  startUrge.addEventListener("click", ()=>{
    if (urgeTimer){ clearInterval(urgeTimer); urgeTimer=null; }
    let secs = 180;
    urgeClock.textContent = "03:00";
    urgeTimer = setInterval(()=>{
      secs--;
      if (secs<=0){ clearInterval(urgeTimer); urgeTimer=null; urgeClock.textContent="Done ✓"; return; }
      const m = String(Math.floor(secs/60)).padStart(2,"0");
      const s = String(secs%60).padStart(2,"0");
      urgeClock.textContent = `${m}:${s}`;
    }, 1000);
  });

  // ===== Persistence =====
  const KEY = "money-coach-v1";

  function collectAll(){
    return {
      budget:{
        income:+inputs.income.value||0,
        loans:+inputs.loans.value||0,
        mom:+inputs.mom.value||0,
        aptSupport:+inputs.aptSupport.value||0,
        phone:+inputs.phone.value||0,
        transport:+inputs.transport.value||0,
        groceries:+inputs.groceries.value||0,
        otherEss:+inputs.otherEss.value||0,
        fun:+inputs.fun.value||0,
        personal:+inputs.personal.value||0,
        zazaCap:+inputs.zazaCap.value||0,
        efTarget:+inputs.efTarget.value||0,
        efNow:+inputs.efNow.value||0,
      },
      cannabis:{
        price:+inputs.pricePerGram.value||0,
        grams:+inputs.gramsPerWeek.value||0,
        cutPct:+inputs.zazaCutPct.value||0
      },
      debts: readDebts(),
      debtSettings:{
        strategy: $("#strategy").value,
        extra:+inputs.extraDebt.value||0
      },
      psych:{
        impl: $("#implIntents").value
      },
      family:{
        purpose:$("#famPurpose").value,
        parties:$("#famParties").value,
        amount:+$("#famAmount").value||0,
        start:$("#famStart").value,
        review:$("#famReview").value,
        end:$("#famEnd").value,
        late:$("#famLate").value,
        adj:$("#famAdj").value,
        notes:$("#famNotes").value
      }
    };
  }

  function applyAll(d){
    if (d.budget){
      Object.assign(inputs.income, {value:d.budget.income??inputs.income.value});
      inputs.loans.value = d.budget.loans??inputs.loans.value;
      inputs.mom.value = d.budget.mom??inputs.mom.value;
      inputs.aptSupport.value = d.budget.aptSupport??inputs.aptSupport.value;
      inputs.phone.value = d.budget.phone??inputs.phone.value;
      inputs.transport.value = d.budget.transport??inputs.transport.value;
      inputs.groceries.value = d.budget.groceries??inputs.groceries.value;
      inputs.otherEss.value = d.budget.otherEss??inputs.otherEss.value;
      inputs.fun.value = d.budget.fun??inputs.fun.value;
      inputs.personal.value = d.budget.personal??inputs.personal.value;
      inputs.zazaCap.value = d.budget.zazaCap??inputs.zazaCap.value;
      inputs.efTarget.value = d.budget.efTarget??inputs.efTarget.value;
      inputs.efNow.value = d.budget.efNow??inputs.efNow.value;
    }
    if (d.cannabis){
      inputs.pricePerGram.value = d.cannabis.price??inputs.pricePerGram.value;
      inputs.gramsPerWeek.value = d.cannabis.grams??inputs.gramsPerWeek.value;
      inputs.zazaCutPct.value = d.cannabis.cutPct??inputs.zazaCutPct.value;
      recomputeZaza();
    }
    if (d.debts){
      debtsTbl.innerHTML="";
      d.debts.forEach(addDebtRow);
    }
    if (d.debtSettings){
      $("#strategy").value = d.debtSettings.strategy||"avalanche";
      inputs.extraDebt.value = d.debtSettings.extra||0;
    }
    if (d.psych){
      $("#implIntents").value = d.psych.impl||"";
    }
    if (d.family){
      $("#famPurpose").value = d.family.purpose||"";
      $("#famParties").value = d.family.parties||"";
      $("#famAmount").value = d.family.amount||0;
      $("#famStart").value = d.family.start||"";
      $("#famReview").value = d.family.review||"";
      $("#famEnd").value = d.family.end||"";
      $("#famLate").value = d.family.late||"";
      $("#famAdj").value = d.family.adj||"";
      $("#famNotes").value = d.family.notes||"";
    }
    recomputeBudget();
  }

  function persist(){ localStorage.setItem(KEY, JSON.stringify(collectAll())); }
  function load(){ const raw = localStorage.getItem(KEY); if(raw){ try{ applyAll(JSON.parse(raw)); }catch(e){} } recomputeZaza(); recomputeBudget(); }

  $("#save").addEventListener("click", ()=>{ persist(); alert("Saved!"); });
  $("#reset").addEventListener("click", ()=>{
    if (!confirm("Reset to defaults?")) return;
    localStorage.removeItem(KEY);
    location.reload();
  });

  // Listen to all numeric changes
  document.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", ()=>{
      if (el===inputs.pricePerGram || el===inputs.gramsPerWeek){ recomputeZaza(); }
      if (["income","loans","mom","aptSupport","phone","transport","groceries","otherEss","fun","personal","zazaCap","efTarget","efNow"].includes(el.id)){
        recomputeBudget();
      }
      persist();
    });
  });

  // Init
  load();
  simulatePayoff();
</script>
</body>
</html>
