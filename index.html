<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rahakäsk – Kuu‑põhine eelarve + võlad</title>
<style>
  :root{
    --bg:#0f1221; --card:#171a2e; --ink:#e9ecff; --muted:#aab1d9; --accent:#7c9bff;
    --good:#38d39f; --warn:#ffb648; --bad:#ff6b6b; --line:#242845;
    --frost:rgba(124,155,255,.08);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:radial-gradient(circle at top,var(--card) 0%,var(--bg) 52%,#070915 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.6;font-size:15px}
  h1,h2,h3{margin:0;font-weight:600}
  header{padding:18px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,#10132a 0%,rgba(15,18,33,.9) 65%,rgba(15,18,33,.5) 100%);backdrop-filter: blur(8px);z-index:5}
  header h1{margin:0;font-size:18px;letter-spacing:.4px}
  header .sub{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  header .date,.monthBadge{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b0e1d;font-variant-numeric:tabular-nums;box-shadow:0 8px 16px -12px rgba(0,0,0,.7)}
  .monthBadge{color:var(--accent)}
  main{max-width:1150px;margin:28px auto;padding:0 16px 90px}

  .grid{display:grid;gap:18px}
  @media (min-width: 980px){
    .grid-2{grid-template-columns:1.2fr .8fr}
  }

  .card{background:rgba(18,22,41,.9);border:1px solid rgba(124,155,255,.15);border-radius:18px;padding:0;overflow:hidden;box-shadow:0 26px 50px -34px rgba(7,12,32,.85);backdrop-filter:blur(6px)}
  summary{list-style:none;padding:16px 18px;background:linear-gradient(90deg,rgba(124,155,255,.12),rgba(124,155,255,0));cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:12px}
  summary::-webkit-details-marker{display:none}
  summary h2{font-size:17px}
  .sum-left{display:flex;align-items:center;gap:12px;min-width:0}
  .sum-left h2{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
  .chev{transition:transform .2s ease;color:var(--accent)}
  details[open] .chev{transform:rotate(90deg)}
  .content{padding:18px;border-top:1px solid rgba(124,155,255,.15);display:flex;flex-direction:column;gap:10px}
  .row{display:flex;gap:12px;align-items:center}
  label{font-size:13px;color:var(--muted);min-width:210px}
  input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(124,155,255,.18);background:rgba(7,10,25,.72);color:var(--ink);outline:none;font-size:15px;transition:border-color .2s ease,box-shadow .2s ease,background .2s ease}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,155,255,.2);background:rgba(7,10,25,.92)}
  textarea{min-height:90px;resize:vertical}
  .mono{font-variant-numeric:tabular-nums}
  .btn{border:1px solid rgba(124,155,255,.2);background:rgba(7,10,25,.78);color:var(--ink);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:500;transition:transform .15s ease,box-shadow .15s ease,border-color .2s ease;background-image:linear-gradient(135deg,rgba(124,155,255,.18),rgba(124,155,255,.05));backdrop-filter:blur(4px)}
  .btn:hover{border-color:var(--accent);box-shadow:0 12px 28px -18px rgba(124,155,255,.6);transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b0e1d;font-weight:600;box-shadow:0 10px 22px -14px rgba(124,155,255,.9)}
  .payWrap{display:flex;gap:10px;width:100%;align-items:center}
  .payWrap input{flex:1}
  .btn.payToggle{white-space:nowrap}
  .btn.payToggle.paid{background:var(--good);border-color:var(--good);color:#0b0e1d;font-weight:600}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid rgba(124,155,255,.25);font-size:12px;color:var(--accent);margin-left:10px;background:rgba(124,155,255,.12);box-shadow:0 12px 24px -20px rgba(124,155,255,.7)}
  .kpi{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .kpi .box{flex:1;background:rgba(7,10,25,.72);border:1px solid rgba(124,155,255,.15);border-radius:14px;padding:14px;min-width:180px;box-shadow:0 18px 36px -30px rgba(7,10,25,.9)}
  .kpi .box .label{color:var(--muted);font-size:11px;margin-bottom:6px}
  .kpi .box .val{font-size:20px;font-weight:700}
  .tableWrap{overflow-x:auto;border-radius:14px;border:1px solid rgba(124,155,255,.15);background:rgba(7,10,25,.65)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid rgba(124,155,255,.12);padding:12px 14px;text-align:left;font-size:14px}
  th:first-child,td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  th:last-child,td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  thead th{background:rgba(124,155,255,.12);color:var(--muted);font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.6px}
  tbody tr{background:rgba(124,155,255,.04);transition:background .2s ease,transform .2s ease}
  tbody tr:nth-child(even){background:rgba(124,155,255,.08)}
  tbody tr:hover{background:rgba(124,155,255,.15);transform:translateY(-1px)}
  tfoot td{font-weight:700;background:rgba(124,155,255,.1)}
  .right{text-align:right}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .row.is-paid label{color:var(--good)}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .progress{height:10px;background:rgba(7,10,25,.7);border:1px solid rgba(124,155,255,.18);border-radius:999px;overflow:hidden}
  .progress > div{height:100%;background:linear-gradient(90deg,var(--accent),#9ce7ff);width:0%}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  .archiveItem{padding:10px;border:1px dashed var(--line);border-radius:10px;margin:6px 0}
  tr.paid td{opacity:.75}

  @media (max-width: 900px){
    header{padding:16px 16px}
    header h1{font-size:17px}
    main{padding:0 14px 80px}
    label{min-width:180px}
  }

  @media (max-width: 720px){
    header{position:static;border-bottom:none;background:transparent;padding:18px 14px 0}
    header h1{font-size:16px}
    header .sub{font-size:11px}
    main{margin:18px auto 70px;padding:0 12px}
    .grid-2{grid-template-columns:1fr}
    .card{border-radius:16px}
    summary{padding:14px 16px}
    summary h2{font-size:16px}
    .pill{margin-left:0}
    .content{padding:16px}
    .row{flex-direction:column;align-items:stretch;gap:6px}
    label{min-width:0;font-size:12px}
    input,select,textarea{font-size:16px}
    .payWrap{flex-direction:column;align-items:stretch}
    .payWrap button{width:100%}
    .kpi{flex-direction:column}
    .kpi .box{min-width:unset}
    .tableWrap{margin:0 -6px;padding:0 6px}
    table{min-width:540px}
    th,td{padding:12px 12px}
  }
</style>
</head>
<body>
<header>
  <h1>Rahakäsk • Kuu‑põhine eelarve + võlad</h1>
  <div class="sub">
    <span class="monthBadge" id="monthBadge">—</span>
    <span class="date" id="todayDate">—</span>
  </div>
</header>

<main class="grid grid-2">
  <!-- VASAK VEERG -->
  <section class="grid">
    <!-- Eelarve -->
    <div class="card">
      <details open>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Sissetulek ja püsikulud (kuu‑põhine)</h2></div>
          <div class="pill" id="pillBudget">—</div>
        </summary>
        <div class="content">
          <div class="row"><label>Kuu netosissetulek (€)</label><input id="income" type="number" class="mono" value="1400" min="0" step="1"></div>
          <h3 class="small muted" style="margin:6px 0 0">Püsikohustused</h3>
          <div class="row"><label>Laenud (€ kuus)</label><div class="payWrap"><input id="loans" type="number" class="mono" value="800" min="0" step="1"><button class="btn payToggle" data-pay-support="loans">Märgi makstuks</button></div></div>
          <div class="row"><label>Toetus emale (€)</label><div class="payWrap"><input id="mom" type="number" class="mono" value="85" min="0" step="1"><input id="momEnd" type="date" title="Lõppeb (k.a)"><button class="btn payToggle" data-pay-support="mom">Märgi makstuks</button></div></div>
          <div class="row"><label>Korteri tugi õele (€)</label><div class="payWrap"><input id="aptSupport" type="number" class="mono" value="140" min="0" step="1"><input id="aptSupportEnd" type="date" title="Lõppeb (k.a)"><button class="btn payToggle" data-pay-support="aptSupport">Märgi makstuks</button></div></div>
          <div class="row"><label>Telefon/Internet (€)</label><input id="phone" type="number" class="mono" value="30" min="0" step="1"></div>
          <div class="row"><label>Transport (€)</label><input id="transport" type="number" class="mono" value="60" min="0" step="1"></div>
          <div class="row"><label>Toit (€)</label><input id="groceries" type="number" class="mono" value="200" min="0" step="1"></div>
          <div class="row"><label>Muud esmavajadused (€)</label><input id="otherEss" type="number" class="mono" value="0" min="0" step="1"></div>
          <div class="divider"></div>
          <h3 class="small muted" style="margin:6px 0 0">Vaba valik</h3>
          <div class="row"><label>Meelelahutus (€)</label><input id="fun" type="number" class="mono" value="20" min="0" step="1"></div>
          <div class="row"><label>Riided/Isiklik (€)</label><input id="personal" type="number" class="mono" value="10" min="0" step="1"></div>
          <div class="row"><label>Kanepi kulu ülempiir (€)</label><input id="zazaCap" type="number" class="mono" value="120" min="0" step="1"></div>
          <div class="divider"></div>
          <h3 class="small muted" style="margin:6px 0 0">Ohutus ja eesmärgid</h3>
          <div class="row"><label>Hädaabifondi siht (€)</label><input id="efTarget" type="number" class="mono" value="300" min="0" step="1"></div>
          <div class="row"><label>Hädaabifondi jääk (€)</label><input id="efNow" type="number" class="mono" value="0" min="0" step="1"></div>

          <div class="divider"></div>
          <div class="row">
            <label>Palgapäev (PP või mitu: 5,20)</label>
            <input id="paydaysInput" placeholder="nt 5 või 5,20" />
          </div>
          <div class="small" id="nextPayInfo"></div>

          <div class="divider"></div>
          <div class="kpi">
            <div class="box"><div class="label">Väljavool kokku</div><div class="val mono" id="kpiOut">—</div></div>
            <div class="box"><div class="label">Ülejääk / Puudujääk</div><div class="val mono" id="kpiLeft">—</div></div>
            <div class="box"><div class="label">Jaotus</div><div class="val mono" id="kpiAlloc">—</div></div>
          </div>
          <div class="note">Iga kuu alguses (või palgapäeval) arhiveeritakse eelmine kuu automaatselt ning alustad värske kuuga.</div>
        </div>
      </details>
    </div>

    <!-- Kanepi kalkulaator -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Kanepi tegelikkuse kontroll</h2></div>
          <div class="pill" id="pillZaza">Zaza alles: —</div>
        </summary>
        <div class="content">
          <div class="row"><label>Hind €/g</label><input id="pricePerGram" type="number" class="mono" value="10" min="0" step="0.1"></div>
          <div class="row"><label>Gramme nädalas</label><input id="gramsPerWeek" type="number" class="mono" value="3" min="0" step="0.1"></div>
          <div class="row"><label>Kuu kulu (auto) (€)</label><input id="zazaAuto" type="number" class="mono" value="" disabled></div>
          <div class="row"><label>Vähenda (%)</label><input id="zazaCutPct" type="number" class="mono" value="25" min="0" max="100"></div>
          <div class='row'><button class="btn" id="applyCap">Sea ülempiir ja liiguta sääst EF-i</button><span class="small" id="capMsg" style="margin-left:8px;"></span></div>
          <div class="divider"></div>
          <div class="small">Kulude jälgija all arvestatakse Zaza kulud eraldi.</div>
          <div class="progress"><div id="zazaProg"></div></div>
        </div>
      </details>
    </div>

    <!-- Kulutuste jälgija -->
    <div class="card">
      <details open>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Kulutuste jälgija (selle kuu)</h2></div>
          <div class="pill" id="pillSpent">Sel kuul: —</div>
        </summary>
        <div class="content">
          <div class="row">
            <label>Kategooria</label>
            <select id="expCat">
              <option>Zaza</option>
              <option>Telefon/Internet</option>
              <option>Toit</option>
              <option>Transport</option>
              <option>Meelelahutus</option>
              <option>Riided/Isiklik</option>
              <option>Muu</option>
            </select>
          </div>
          <div class="row"><label>Summa (€)</label><input id="expAmt" type="number" class="mono" min="0" step="0.01" /></div>
          <div class="row"><label>Kuupäev</label><input id="expDate" type="date" /></div>
          <div class="row"><label>Märkus</label><input id="expNote" type="text" placeholder="mis, kus, kelle jaoks"></div>
          <div class="row"><button class="btn primary" id="addExp">+ Lisa kulu</button></div>

          <div class="divider"></div>
          <div class="tableWrap">
            <table id="expTbl">
              <thead><tr><th>Kuupäev</th><th>Kategooria</th><th>Märkus</th><th class="right">€</th><th></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="3"><strong>Kokku (kuu):</strong></td><td class="right mono" id="expSum">0.00</td><td></td></tr></tfoot>
            </table>
          </div>

          <div class="divider"></div>
          <h3>Sel kuul kategooriate kaupa</h3>
          <div id="expBreakdown" class="small"></div>
        </div>
      </details>
    </div>
  </section>

  <!-- PAREM VEERG -->
  <section class="grid">
    <!-- Arhiiv (loe‑ainult) -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Arhiiv (varasemad kuud)</h2></div>
        </summary>
        <div class="content">
          <div id="archivesList" class="small"></div>
          <div class="note">Arhiivi kirjed tekivad automaatselt, kui kuu vahetub. Sisaldab kogu eelmise kuu seisu.</div>
        </div>
      </details>
    </div>

    <!-- Psühholoogia -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Psühholoogianipid</h2></div>
        </summary>
        <div class="content">
          <h3>Tegevuskavad</h3>
          <textarea id="implIntents">Kui kell on pärast 22:30 ja tekib isu, teen teed ja teen 8-min venituse; kui ikka tahan, jään oma piirangu juurde.</textarea>
          <h3>Tahtmise laine (3 minutit)</h3>
          <div class="row">
            <button class="btn" id="startUrge">Käivita 3:00</button>
            <div id="urgeClock" class="pill mono">03:00</div>
          </div>
          <h3>Nädalane kontroll (10 min)</h3>
          <ul class="small">
            <li>Logi tegelikud kulud eelarvesse.</li>
            <li>Kontrolli kanepi “ümbriku”/alamkontot.</li>
            <li>Kui läheb üle, kärbi sel nädalal (mitte järgmisel kuul).</li>
            <li>Tähista üks võit (nt “€40 → Hädaabifond”).</li>
          </ul>
        </div>
      </details>
    </div>

    <!-- Jooksev kokkuvõte -->
    <div class="card">
      <details open>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Jooksev kokkuvõte</h2></div>
        </summary>
        <div class="content">
          <div id="liveSummary" class="small"></div>
        </div>
      </details>
    </div>
  </section>
</main>

<script>
  // ===== Abi =====
  const $ = sel => document.querySelector(sel);
  const fmt = n => isFinite(n) ? (Number(n).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})) : '—';
  const fmt2 = n => isFinite(n) ? (Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})) : '—';
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

  // Päis
  const todayDate = $("#todayDate");
  const monthBadge = $("#monthBadge");
  const now = new Date();
  todayDate.textContent = now.toLocaleDateString(undefined,{weekday:'long', year:'numeric', month:'long', day:'numeric'});
  monthBadge.textContent = now.toLocaleDateString(undefined,{month:'long', year:'numeric'});

  // Elemendid
  const inputs = {
    income:      $("#income"),
    loans:       $("#loans"),
    mom:         $("#mom"),
    momEnd:      $("#momEnd"),
    aptSupport:  $("#aptSupport"),
    aptSupportEnd:$("#aptSupportEnd"),
    phone:       $("#phone"),
    transport:   $("#transport"),
    groceries:   $("#groceries"),
    otherEss:    $("#otherEss"),
    fun:         $("#fun"),
    personal:    $("#personal"),
    zazaCap:     $("#zazaCap"),
    efTarget:    $("#efTarget"),
    efNow:       $("#efNow"),
    pricePerGram:$("#pricePerGram"),
    gramsPerWeek:$("#gramsPerWeek"),
    zazaAuto:    $("#zazaAuto"),
    zazaCutPct:  $("#zazaCutPct"),
    applyCap:    $("#applyCap"),
    paydays:     $("#paydaysInput"),
  };

  const kpis = {
    out:   $("#kpiOut"),
    left:  $("#kpiLeft"),
    alloc: $("#kpiAlloc"),
  };

  const summary = $("#liveSummary");
  const pillBudget = $("#pillBudget");
  const pillZaza = $("#pillZaza");
  const pillSpent = $("#pillSpent");
  const zazaProg = $("#zazaProg");
  const archivesList = $("#archivesList");
  const CATEGORY_LABELS = {
    'Zaza': 'Kanepi kulu ülempiir',
    'Telefon/Internet': 'Telefon/Internet',
    'Toit': 'Toit',
    'Transport': 'Transport',
    'Meelelahutus': 'Meelelahutus',
    'Riided/Isiklik': 'Riided/Isiklik',
    'Muu': 'Muud esmavajadused'
  };
  const CATEGORY_ORDER = ['Zaza','Telefon/Internet','Toit','Transport','Meelelahutus','Riided/Isiklik','Muu'];
  const SUPPORT_KEYS = ['loans','mom','aptSupport'];
  let currentMonthExpenses = [];

  // ===== Kuu‑põhine püsivus =====
  const KEY = "rahakask-v5";
  const KEY_EXP = "rahakask-v5-expenses"; // ainult jooksva kuu kulud
  const CUR_MONTH = monthKey(new Date());
  let payMarksCache = null;
  const defaultPayMarks = () => ({supports:{loans:false,mom:false,aptSupport:false}});
  function readState(){ try{ return JSON.parse(localStorage.getItem(KEY)||"{}"); }catch(e){ return {}; } }
  function writeState(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
  function getPayMarks(){
    if(payMarksCache) return payMarksCache;
    const state = readState();
    state.payMarks = state.payMarks || {};
    const existing = state.payMarks[CUR_MONTH];
    if(existing){
      payMarksCache = {
        supports: Object.assign({loans:false,mom:false,aptSupport:false}, existing.supports||{})
      };
    } else {
      payMarksCache = defaultPayMarks();
    }
    state.payMarks[CUR_MONTH] = payMarksCache;
    writeState(state);
    return payMarksCache;
  }
  function savePayMarks(){
    if(!payMarksCache) return;
    const state = readState();
    state.payMarks = state.payMarks || {};
    state.payMarks[CUR_MONTH] = payMarksCache;
    writeState(state);
  }
  function resetPayMarksCache(){ payMarksCache = null; }

  
  
  function archiveIfMonthRolled(){
    const state = readState();
    const cur = monthKey(new Date());
    const storedMonth = (state.meta && state.meta.month) || null;

    const hadMeta = !!storedMonth;
    const monthChanged = hadMeta && storedMonth !== cur;

    state.archives = state.archives || [];
    state.data = state.data || {};

    if (monthChanged){
      // Load all expenses (previous + current) from store
      let allExpenses = [];
      try { allExpenses = JSON.parse(localStorage.getItem(KEY_EXP) || "[]"); } catch (e) { allExpenses = []; }
      const prevMonth = storedMonth; // e.g., "2025-09"
      const prevMonthExpenses = allExpenses.filter(e => String(e.date||"").slice(0,7) === prevMonth);

      // Compute initial carryOver (leftover cash) based on previous month
      const b = (state.data && state.data.budget) || {};
      const income = +b.income || 0;
      const prevAsOf = new Date(prevMonth+"-01T00:00:00");
      const obligations = monthlyObligations({
        loans: b.loans,
        mom: b.mom,
        momEnd: b.momEnd,
        aptSupport: b.aptSupport,
        aptSupportEnd: b.aptSupportEnd,
        phone: b.phone
      }, prevAsOf);
      const spent = spentForMonth(prevMonth, prevMonthExpenses);
      let carryOver = income - obligations - spent;
      if (!isFinite(carryOver)) carryOver = 0;
      if (carryOver < 0) carryOver = 0;

      const archiveEntry = {
        month: prevMonth,
        ts: Date.now(),
        data: state.data || {},
        expenses: prevMonthExpenses,
        carryOver: carryOver
      };
      state.archives.push(archiveEntry);

      // Apply carryover to EF balance for the new month
      if (!state.data.budget) state.data.budget = {};
      state.data.budget.efNow = (+state.data.budget.efNow || 0) + carryOver;

      // Clear only expenses (new month starts fresh)
      localStorage.removeItem(KEY_EXP);

      // Reset paid markers for the new month
      state.payMarks = state.payMarks || {};
      state.payMarks[prevMonth] && delete state.payMarks[prevMonth];
      state.payMarks[cur] = defaultPayMarks();
      resetPayMarksCache();
    }

    // Update current meta month
    state.meta = { month: cur };
    writeState(state);
  }
  function renderArchives(){
    const state = readState();
    const list = (state.archives||[]).slice().reverse();
    if (!list.length){ archivesList.innerHTML = "<em>Arhiiv on tühi.</em>"; return; }
    archivesList.innerHTML = list.map(a=>{
      const tot = (a.expenses||[]).reduce((s,x)=>s+(+x.amt||0),0);
      const minsT = a.payments && a.payments.minsTotal || 0;
      const zaza = (a.expenses||[]).filter(x=>x.cat==="Zaza").reduce((s,x)=>s+(+x.amt||0),0);
      const when = new Date(a.ts).toLocaleString();
      const payLine = a.payments ? `<div>Maksed võlgadele (auto): min <strong>€ ${fmt2(minsT)}</strong></div>` : "";
      return `<div class="archiveItem">
        <div><strong>${a.month}</strong> — arhiveeritud: ${when}</div>
        <div>Kulud kokku: <strong>€ ${fmt2(tot)}</strong>; Zaza: <strong>€ ${fmt2(zaza)}</strong></div>
        ${payLine}
        <div>Ülejääk EF-i: <strong>€ ${fmt2(a.carryOver||0)}</strong></div>
        <div class="small muted">Kirje sisaldab kogu kuu seisu (eelarve ja sätted) ning kõiki kulusid.</div>
      </div>`;
    }).join("");
  }

  function reflectSupportPaid(key){
    const marks = getPayMarks();
    const paid = !!(marks.supports && marks.supports[key]);
    const btn = document.querySelector(`[data-pay-support="${key}"]`);
    if(btn){
      btn.textContent = paid ? "Makstud ✓" : "Märgi makstuks";
      btn.classList.toggle("paid", paid);
      const row = btn.closest(".row");
      if(row) row.classList.toggle("is-paid", paid);
    }
  }
  function toggleSupportPaid(key){
    const marks = getPayMarks();
    marks.supports = marks.supports || {loans:false,mom:false,aptSupport:false};
    marks.supports[key] = !marks.supports[key];
    savePayMarks();
    reflectSupportPaid(key);
    recomputeBudget();
  }
  let supportButtonsInit=false;
  function refreshSupportButtons(){
    document.querySelectorAll('[data-pay-support]').forEach(btn=>{
      const key=btn.getAttribute('data-pay-support');
      reflectSupportPaid(key);
    });
  }
  function initSupportButtons(){
    if(!supportButtonsInit){
      document.querySelectorAll('[data-pay-support]').forEach(btn=>{
        const key=btn.getAttribute('data-pay-support');
        btn.addEventListener('click',()=>{ toggleSupportPaid(key); });
      });
      supportButtonsInit=true;
    }
    refreshSupportButtons();
  }
  // ===== Payday helperid =====
  function parsePaydays(txt){
    if (!txt) return [];
    return String(txt).split(/[,\s]+/).map(s=>parseInt(s,10)).filter(n=>Number.isInteger(n)&&n>=1&&n<=31).sort((a,b)=>a-b);
  }
  function nextDatesFromDays(dayList, from=new Date(), count=3){
    if (!dayList.length) return [];
    const results=[]; let d=new Date(from); d.setHours(12,0,0,0);
    while(results.length<count){
      for(const dd of dayList){
        const y=d.getFullYear(), m=d.getMonth();
        const last=new Date(y,m+1,0).getDate();
        let cand=new Date(y,m,Math.min(dd,last)); cand.setHours(12,0,0,0);
        if(cand<d){ const nm=new Date(y,m+1,1); const last2=new Date(nm.getFullYear(),nm.getMonth()+1,0).getDate(); cand=new Date(nm.getFullYear(),nm.getMonth(),Math.min(dd,last2)); }
        results.push(cand); if(results.length>=count) break;
      }
      d=new Date(results[results.length-1].getTime()+86400000);
    }
    results.sort((a,b)=>a-b);
    const uniq=[]; for(const dt of results){ if(!uniq.length||(+dt!==+uniq[uniq.length-1])) uniq.push(dt); if(uniq.length===count) break; }
    return uniq.slice(0,count);
  }
  function daysBetween(a,b){
    const A=new Date(a.getFullYear(),a.getMonth(),a.getDate());
    const B=new Date(b.getFullYear(),b.getMonth(),b.getDate());
    return Math.ceil((B-A)/86400000);
  }
  function updatePayInfo(){
    const el=inputs.paydays, info=$("#nextPayInfo");
    if(!el||!info) return;
    const days=parsePaydays(el.value);
    if(!days.length){ info.innerHTML="<em>Lisa palgapäeva päev (nt 5 või 5,20).</em>"; return; }
    const next3=nextDatesFromDays(days,new Date(),3);
    const fmtOpts={day:'2-digit',month:'long',year:'numeric'};
    const today=new Date();
    info.innerHTML = next3.map(d=>`• ${d.toLocaleDateString(undefined,fmtOpts)} — <strong>${daysBetween(today,d)} päeva</strong>`).join("<br>");
  }

  // ===== Eelarve =====
  const inputValue = ref => {
    if(!ref) return "";
    if(typeof ref === "object" && "value" in ref) return ref.value;
    return ref;
  };
  /** Kontrollib, kas kohustus on endiselt aktiivne (lõppkuupäev k.a) */
  function isActive(endInput, asOf=new Date()){
    const raw = inputValue(endInput);
    if(!raw) return true;
    const end = new Date(String(raw)+"T23:59:59");
    const ref = new Date(asOf);
    ref.setHours(23,59,59,999);
    return end >= ref;
  }
  /** Tagastab maksesumma, kui kohustus on aktiivne */
  function activeAmt(amountInput,endInput,asOf=new Date()){
    const amt = +inputValue(amountInput) || 0;
    return isActive(endInput, asOf) ? amt : 0;
  }
  /** Kuupõhised kohustused (laenud + toetused) */
  function monthlyObligations(source=inputs, asOf=new Date()){
    const src = source || {};
    const loans = +inputValue(src.loans) || 0;
    return (
      loans +
      activeAmt(src.mom, src.momEnd, asOf) +
      activeAmt(src.aptSupport, src.aptSupportEnd, asOf)
    );
  }
  function supportAmount(key, source=inputs, asOf=new Date()){
    const src = source || {};
    if(key === 'loans') return +inputValue(src.loans) || 0;
    if(key === 'mom') return activeAmt(src.mom, src.momEnd, asOf);
    if(key === 'aptSupport') return activeAmt(src.aptSupport, src.aptSupportEnd, asOf);
    return 0;
  }
  function paidSupportsTotal(asOf=new Date()){
    const marks = getPayMarks();
    if(!marks || !marks.supports) return 0;
    return SUPPORT_KEYS.reduce((sum,key)=>{
      return sum + (marks.supports[key] ? supportAmount(key, inputs, asOf) : 0);
    },0);
  }
  function categoryLimits(source=inputs){
    const src = source || {};
    return {
      'Telefon/Internet': +inputValue(src.phone) || 0,
      'Transport': +inputValue(src.transport) || 0,
      'Toit': +inputValue(src.groceries) || 0,
      'Muu': +inputValue(src.otherEss) || 0,
      'Meelelahutus': +inputValue(src.fun) || 0,
      'Riided/Isiklik': +inputValue(src.personal) || 0,
      'Zaza': +inputValue(src.zazaCap) || 0,
    };
  }
  function sumCategoryLimits(limits){
    return Object.values(limits || {}).reduce((sum,val)=>sum+(+val||0),0);
  }
  function computeOutflows(){
    const obligations = monthlyObligations();
    const limitsTotal = sumCategoryLimits(categoryLimits());
    return obligations + limitsTotal;
  }
  /** Summeeri kulud kuuvõtme alusel */
  function spentForMonth(mk, list){
    const expenses = Array.isArray(list) ? list : readExpenses();
    return expenses
      .filter(e => String(e.date||"").slice(0,7) === mk)
      .reduce((sum, x) => sum + (+x.amt||0), 0);
  }
  /** Kulud jooksval kuul */
  function spentThisMonth(){
    if(Array.isArray(currentMonthExpenses)){
      return currentMonthExpenses.reduce((sum,e)=>sum+(+e.amt||0),0);
    }
    return spentForMonth(monthKey(new Date()));
  }
  function recomputeBudget(){
    const income=+inputs.income.value||0;
    const obligations = monthlyObligations();
    const limits = categoryLimits();
    const limitTotal = sumCategoryLimits(limits);
    const plannedTotal = obligations + limitTotal;
    const plannedLeft = income - plannedTotal;
    const spent = spentThisMonth();
    const paidSupports = paidSupportsTotal();
    const realLeft = income - paidSupports - spent;
    const totalOut=computeOutflows();
    const realClass = realLeft>0?"good":(realLeft===0?"":"bad");
    const obligationsLeft = Math.max(0, obligations - paidSupports);
    kpis.out.textContent="€ "+fmt(totalOut);
    kpis.left.textContent=(realLeft>=0?"€ "+fmt(realLeft):"€ -"+fmt(Math.abs(realLeft)));
    kpis.left.className="val mono "+realClass;
    kpis.alloc.textContent=`Kohustused € ${fmt(obligations)}  |  Limiidid € ${fmt(limitTotal)}  |  Plaanijääk € ${fmt(plannedLeft)}`;
    if(pillBudget) pillBudget.textContent=`Reaaljääk: € ${fmt(realLeft)}`;
    if(summary){
      summary.innerHTML=`
      <div>Sissetulek: <strong>€ ${fmt(income)}</strong></div>
      <div>Kohustuslikud maksed (planeeritud): <strong>€ ${fmt(obligations)}</strong></div>
      <div>Kohustuslikud maksed (makstud): <strong>€ ${fmt(paidSupports)}</strong> <span class="small muted">alles € ${fmt(Math.max(0, obligationsLeft))}</span></div>
      <div>Kulude limiidid: <strong>€ ${fmt(limitTotal)}</strong></div>
      <div>Sel kuul kulud: <strong>€ ${fmt(spent)}</strong></div>
      <div>Plaanijääk (kui järgid limiite): <strong>€ ${fmt(plannedLeft)}</strong></div>
      <div>Reaaljääk (pärast oste): <strong class="${realClass}">€ ${fmt(realLeft)}</strong></div>`;
    }
    renderExpenseBreakdown();
    refreshZazaLeft();
  }

  // ===== Kanepi kalkulaator =====
  const capMsg=$("#capMsg");
  function recomputeZaza(){
    const monthly=(+inputs.pricePerGram.value||0)*(+inputs.gramsPerWeek.value||0)*4.3;
    inputs.zazaAuto.value=(isFinite(monthly)? monthly.toFixed(0):"");
    return monthly;
  }
  if(inputs.applyCap){
    inputs.applyCap.addEventListener("click",()=>{
      const monthly=recomputeZaza();
      const cutPct=clamp(+inputs.zazaCutPct.value||0,0,100);
      const newCap=Math.round(monthly*(1-cutPct/100));
      const savings=Math.max(0,Math.round(monthly-newCap));
      inputs.zazaCap.value=newCap;
      const efNeed=Math.max(0,(+inputs.efTarget.value||0)-(+inputs.efNow.value||0));
      if(capMsg) capMsg.textContent=`Ülempiir €${fmt(newCap)}. Sääst €${fmt(savings)} suunatud EF-i (vajadus €${fmt(efNeed)}).`;
      recomputeBudget(); persist();
    });
  }
  // ===== Tahtmise taimer =====
  const startUrge=$("#startUrge"); const urgeClock=$("#urgeClock"); let urgeTimer=null;
  if(startUrge){ startUrge.addEventListener("click",()=>{ if(urgeTimer){clearInterval(urgeTimer); urgeTimer=null;} let secs=180; if(urgeClock) urgeClock.textContent="03:00";
    urgeTimer=setInterval(()=>{ secs--; if(secs<=0){clearInterval(urgeTimer); urgeTimer=null; if(urgeClock) urgeClock.textContent="Valmis ✓"; return;}
      const m=String(Math.floor(secs/60)).padStart(2,"0"); const s=String(secs%60).padStart(2,"0"); if(urgeClock) urgeClock.textContent=`${m}:${s}`; },1000);
  });}

  // ===== Kulutuste jälgija =====
  const expTblBody=$("#expTbl tbody"); const expSum=$("#expSum"); const expBreakdown=$("#expBreakdown");
  const expCat=$("#expCat"); const expAmt=$("#expAmt"); const expDate=$("#expDate"); const expNote=$("#expNote"); const addExp=$("#addExp");
  function todayISO(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
  if(expDate) expDate.value=todayISO();

  function readExpenses(){ try{ return JSON.parse(localStorage.getItem(KEY_EXP)||"[]"); }catch(e){ return []; } }
  function writeExpenses(list){ localStorage.setItem(KEY_EXP, JSON.stringify(list)); }
  function addExpenseRow(e, idx){
    const tr=document.createElement("tr"); const when=new Date(e.date);
    tr.innerHTML=`<td>${isFinite(when)? when.toLocaleDateString():e.date}</td><td>${e.cat}</td><td>${e.note? e.note.replace(/</g,'&lt;'):''}</td><td class="right mono">${fmt2(e.amt)}</td><td><button class="btn" data-i="${idx}">✕</button></td>`;
    tr.querySelector("button").addEventListener("click",(ev)=>{ const i=+ev.currentTarget.getAttribute("data-i"); const all=readExpenses(); all.splice(i,1); writeExpenses(all); renderExpenses(); persist(); });
    expTblBody.appendChild(tr);
  }
  function renderExpenseBreakdown(list){
    if(!expBreakdown) return;
    const limits = categoryLimits();
    const data = Array.isArray(list) ? list : currentMonthExpenses;
    const byCat={};
    (data||[]).forEach(e=>{
      const cat=(e&&e.cat)||'Muu';
      byCat[cat]=(byCat[cat]||0)+(+e.amt||0);
    });
    const cats=new Set([
      ...Object.keys(byCat),
      ...Object.entries(limits).filter(([,limit])=>limit>0).map(([cat])=>cat)
    ]);
    if(!cats.size){
      expBreakdown.innerHTML="<em>Sel kuul kulusid pole.</em>";
      return;
    }
    const ordered=[];
    CATEGORY_ORDER.forEach(cat=>{ if(cats.has(cat)){ ordered.push(cat); cats.delete(cat);} });
    Array.from(cats).sort().forEach(cat=>ordered.push(cat));
    const rows=ordered.map(cat=>{
      const spent=+byCat[cat]||0;
      const limit=+limits[cat]||0;
      const label=CATEGORY_LABELS[cat]||cat;
      if(limit>0){
        const left=limit-spent;
        let statusClass='muted';
        let statusText=`alles € ${fmt2(Math.max(0,left))}`;
        if(left<0){
          statusClass='bad';
          statusText=`ületatud € ${fmt2(Math.abs(left))}`;
        } else if(spent>0){
          const ratio=limit?spent/limit:0;
          if(ratio>=1){
            statusClass='bad';
            statusText=`ületatud € ${fmt2(Math.abs(left))}`;
          } else if(ratio>=0.95){
            statusClass='warn';
          } else {
            statusClass='good';
          }
        } else {
          statusClass='good';
          statusText=`alles € ${fmt2(limit)}`;
        }
        return `<div>• ${label}: <strong>€ ${fmt2(spent)}</strong> / € ${fmt2(limit)} <span class="${statusClass}">(${statusText})</span></div>`;
      }
      if(spent>0){
        return `<div>• ${label}: <strong>€ ${fmt2(spent)}</strong></div>`;
      }
      return '';
    }).filter(Boolean);
    expBreakdown.innerHTML=rows.length?rows.join(""):"<em>Sel kuul kulusid pole.</em>";
  }
  function renderExpenses(){
    const all=readExpenses(); const mk=monthKey(new Date());
    const monthList=all.filter(e=> (e.date||"").slice(0,7)===mk);
    currentMonthExpenses = monthList.slice();
    expTblBody.innerHTML=""; monthList.forEach((e,i)=> addExpenseRow(e, readExpenses().indexOf(e)));
    const total=monthList.reduce((a,b)=>a+(+b.amt||0),0); expSum.textContent=fmt2(total);
    renderExpenseBreakdown(monthList);
    pillSpent.textContent=`Sel kuul: € ${fmt2(total)}`; refreshZazaLeft();
    recomputeBudget();
  }
  if(addExp){ addExp.addEventListener("click",()=>{
      const e={ cat: expCat.value, amt:+expAmt.value||0, date: expDate.value||todayISO(), note: expNote.value||"" };
      if(!e.amt){ alert("Sisesta summa."); return; } const all=readExpenses(); all.push(e); writeExpenses(all);
      expAmt.value=""; expNote.value=""; renderExpenses(); persist();
  });}

  function refreshZazaLeft(){
    const cap=+inputs.zazaCap.value||0; const all=readExpenses(); const mk=monthKey(new Date());
    const zazaSpent=all.filter(e=> (e.date||"").slice(0,7)===mk && e.cat==="Zaza").reduce((a,b)=>a+(+b.amt||0),0);
    const left=Math.max(0, cap-zazaSpent); pillZaza.textContent=`Zaza alles: € ${fmt2(left)}`;
    const usedPct=cap>0? Math.max(0,Math.min(100,(zazaSpent/cap)*100)):0;
    if(zazaProg){ zazaProg.style.width=usedPct+"%"; zazaProg.style.background= usedPct>100?"var(--bad)":(usedPct>90?"var(--warn)":"var(--accent)"); }
  }

  // ===== Persist + rakenduse laadimine =====
  function collectData(){
    return {
      budget:{
        income:+inputs.income.value||0, loans:+inputs.loans.value||0, mom:+inputs.mom.value||0, momEnd:inputValue(inputs.momEnd), aptSupport:+inputs.aptSupport.value||0, aptSupportEnd:inputValue(inputs.aptSupportEnd),
        phone:+inputs.phone.value||0, transport:+inputs.transport.value||0, groceries:+inputs.groceries.value||0, otherEss:+inputs.otherEss.value||0,
        fun:+inputs.fun.value||0, personal:+inputs.personal.value||0, zazaCap:+inputs.zazaCap.value||0, efTarget:+inputs.efTarget.value||0, efNow:+inputs.efNow.value||0
      },
      cannabis:{ price:+inputs.pricePerGram.value||0, grams:+inputs.gramsPerWeek.value||0, cutPct:+inputs.zazaCutPct.value||0 },
      user:{ paydays: (inputs.paydays||{}).value || "" },
      psych:{ impl: ($("#implIntents")||{}).value || "" }
    };
  }
  function applyData(d){
    if(d.budget){ for(const k in d.budget){ if(inputs[k]&&typeof d.budget[k]!=="undefined") inputs[k].value=d.budget[k]; } }
    if(d.cannabis){ inputs.pricePerGram.value=d.cannabis.price||0; inputs.gramsPerWeek.value=d.cannabis.grams||0; inputs.zazaCutPct.value=d.cannabis.cutPct||0; }
    if(d.user&&inputs.paydays){ inputs.paydays.value=d.user.paydays||""; }
    if(d.psych&&$("#implIntents")){ $("#implIntents").value=d.psych.impl||""; }
  }
  function persist(){ const state=readState(); state.data=collectData(); writeState(state); }

  function load(){
    archiveIfMonthRolled();
    initSupportButtons();
    const state=readState(); applyData(state.data||{});
    // init
    recomputeZaza();
    recomputeBudget();
    renderExpenses();
    updatePayInfo();
    renderArchives();
  }

  document.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", ()=>{
      if(el===inputs.pricePerGram || el===inputs.gramsPerWeek){ recomputeZaza(); }
      if(["income","loans","mom","momEnd","aptSupport","aptSupportEnd","phone","transport","groceries","otherEss","fun","personal","zazaCap","efTarget","efNow"].includes(el.id)){ recomputeBudget(); }
      if(el===inputs.paydays){ updatePayInfo(); }
      persist();
    });
  });

  // Käivitus
  load();
</script>
</body>
</html>
