<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rahakäsk – Kuu‑põhine eelarve + võlad</title>
<style>
  :root{
    --bg:#0f1221; --card:#171a2e; --ink:#e9ecff; --muted:#aab1d9; --accent:#7c9bff;
    --good:#38d39f; --warn:#ffb648; --bad:#ff6b6b; --line:#242845;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{padding:18px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,#0f1221 0%,rgba(15,18,33,.8) 100%);backdrop-filter: blur(6px);z-index:5}
  header h1{margin:0;font-size:18px;letter-spacing:.4px}
  header .sub{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  header .date{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#0b0e1d;font-variant-numeric:tabular-nums}
  .monthBadge{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#0b0e1d}
  main{max-width:1150px;margin:24px auto;padding:0 16px 80px}

  .grid{display:grid;gap:16px}
  @media (min-width: 980px){
    .grid-2{grid-template-columns:1.2fr .8fr}
  }

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:0;overflow:hidden}
  summary{list-style:none;padding:14px 16px;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
  summary::-webkit-details-marker{display:none}
  .sum-left{display:flex;align-items:center;gap:10px}
  .chev{transition:transform .2s ease}
  details[open] .chev{transform:rotate(90deg)}
  .content{padding:14px 16px;border-top:1px solid var(--line)}
  .row{display:flex;gap:10px;align-items:center;margin:8px 0}
  label{font-size:13px;color:var(--muted);min-width:200px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b0e1d;color:var(--ink);outline:none}
  textarea{min-height:80px;resize:vertical}
  .mono{font-variant-numeric:tabular-nums}
  .btn{border:1px solid var(--line);background:#0b0e1d;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#2b315a}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b0e1d;font-weight:600}
  .payWrap{display:flex;gap:8px;width:100%;align-items:center}
  .payWrap input{flex:1}
  .btn.payToggle{white-space:nowrap}
  .btn.payToggle.paid{background:var(--good);border-color:var(--good);color:#0b0e1d;font-weight:600}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);margin-left:10px}
  .kpi{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .kpi .box{flex:1;background:#0b0e1d;border:1px solid var(--line);border-radius:12px;padding:12px;min-width:180px}
  .kpi .box .label{color:var(--muted);font-size:11px;margin-bottom:6px}
  .kpi .box .val{font-size:20px;font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:14px}
  th{color:var(--muted);font-weight:600}
  tfoot td{font-weight:700}
  .right{text-align:right}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .muted{color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .row.is-paid label{color:var(--good)}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .progress{height:10px;background:#0b0e1d;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .progress > div{height:100%;background:var(--accent);width:0%}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  .archiveItem{padding:10px;border:1px dashed var(--line);border-radius:10px;margin:6px 0}
  tr.paid td{opacity:.75}
</style>
</head>
<body>
<header>
  <h1>Rahakäsk • Kuu‑põhine eelarve + võlad</h1>
  <div class="sub">
    <span class="monthBadge" id="monthBadge">—</span>
    <span class="date" id="todayDate">—</span>
  </div>
</header>

<main class="grid grid-2">
  <!-- VASAK VEERG -->
  <section class="grid">
    <!-- 1) Eelarve -->
    <div class="card">
      <details open>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>1) Sissetulek ja püsikulud (kuu‑põhine)</h2></div>
          <div class="pill" id="pillBudget">—</div>
        </summary>
        <div class="content">
          <div class="row"><label>Kuu netosissetulek (€)</label><input id="income" type="number" class="mono" value="1400" min="0" step="1"></div>
          <h3 class="small muted" style="margin:6px 0 0">Püsikohustused</h3>
          <div class="row"><label>Laenud (min kokku) (€)</label><input id="loans" type="number" class="mono" value="800" min="0" step="1"></div>
          <div class="row"><label>Toetus emale (€)</label><div class="payWrap"><input id="mom" type="number" class="mono" value="85" min="0" step="1"><button class="btn payToggle" data-pay-support="mom">Märgi makstuks</button></div></div>
          <div class="row"><label>Korteri tugi õele (€)</label><div class="payWrap"><input id="aptSupport" type="number" class="mono" value="140" min="0" step="1"><button class="btn payToggle" data-pay-support="aptSupport">Märgi makstuks</button></div></div>
          <div class="row"><label>Telefon/Internet (€)</label><input id="phone" type="number" class="mono" value="30" min="0" step="1"></div>
          <div class="row"><label>Transport (€)</label><input id="transport" type="number" class="mono" value="60" min="0" step="1"></div>
          <div class="row"><label>Toit (€)</label><input id="groceries" type="number" class="mono" value="200" min="0" step="1"></div>
          <div class="row"><label>Muud esmavajadused (€)</label><input id="otherEss" type="number" class="mono" value="0" min="0" step="1"></div>
          <div class="divider"></div>
          <h3 class="small muted" style="margin:6px 0 0">Vaba valik</h3>
          <div class="row"><label>Meelelahutus (€)</label><input id="fun" type="number" class="mono" value="20" min="0" step="1"></div>
          <div class="row"><label>Riided/Isiklik (€)</label><input id="personal" type="number" class="mono" value="10" min="0" step="1"></div>
          <div class="row"><label>Kanepi kulu ülempiir (€)</label><input id="zazaCap" type="number" class="mono" value="120" min="0" step="1"></div>
          <div class="divider"></div>
          <h3 class="small muted" style="margin:6px 0 0">Ohutus ja eesmärgid</h3>
          <div class="row"><label>Hädaabifondi siht (€)</label><input id="efTarget" type="number" class="mono" value="300" min="0" step="1"></div>
          <div class="row"><label>Hädaabifondi jääk (€)</label><input id="efNow" type="number" class="mono" value="0" min="0" step="1"></div>

          <div class="divider"></div>
          <div class="row">
            <label>Palgapäev (PP või mitu: 5,20)</label>
            <input id="paydaysInput" placeholder="nt 5 või 5,20" />
          </div>
          <div class="small" id="nextPayInfo"></div>

          <div class="divider"></div>
          <div class="kpi">
            <div class="box"><div class="label">Väljavool kokku</div><div class="val mono" id="kpiOut">—</div></div>
            <div class="box"><div class="label">Ülejääk / Puudujääk</div><div class="val mono" id="kpiLeft">—</div></div>
            <div class="box"><div class="label">Jaotus</div><div class="val mono" id="kpiAlloc">—</div></div>
          </div>
          <div class="note">Iga kuu alguses (või palgapäeval) arhiveeritakse eelmine kuu automaatselt ning alustad värske kuuga.</div>
        </div>
      </details>
    </div>

    <!-- 2) Kanepi kalkulaator -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>2) Kanepi tegelikkuse kontroll</h2></div>
          <div class="pill" id="pillZaza">Zaza alles: —</div>
        </summary>
        <div class="content">
          <div class="row"><label>Hind €/g</label><input id="pricePerGram" type="number" class="mono" value="10" min="0" step="0.1"></div>
          <div class="row"><label>Gramme nädalas</label><input id="gramsPerWeek" type="number" class="mono" value="3" min="0" step="0.1"></div>
          <div class="row"><label>Kuu kulu (auto) (€)</label><input id="zazaAuto" type="number" class="mono" value="" disabled></div>
          <div class="row"><label>Vähenda (%)</label><input id="zazaCutPct" type="number" class="mono" value="25" min="0" max="100"></div>
          <div class='row'><button class="btn" id="applyCap">Sea ülempiir ja liiguta sääst EF-i</button><span class="small" id="capMsg" style="margin-left:8px;"></span></div>
          <div class="divider"></div>
          <div class="small">Kulude jälgija all arvestatakse Zaza kulud eraldi.</div>
          <div class="progress"><div id="zazaProg"></div></div>
        </div>
      </details>
    </div>

    <!-- 3) Võlaplaan -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>3) Võlaplaan (snowball, ilma intressita)</h2></div>
          <div class="pill" id="pillDebt">—</div>
        </summary>
        <div class="content">
          <div class="row"><button class="btn" id="addDebt">+ Lisa võlg</button> <button class="btn" id="exportDebtCsv">Ekspordi CSV</button></div>
          <table id="debtsTbl">
            <thead>
              <tr>
                <th>Võlg</th><th class="right">Jääk (€)</th><th class="right">Miinimum (€)</th><th>Tähtaeg (PP)</th><th>Märkused</th><th>Makstud?</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><td><strong>Kokku</strong></td><td class="right mono" id="sumBal">0</td>
                  <td class="right mono" id="sumMin">0</td><td></td><td></td><td></td><td></td></tr>
            </tfoot>
          </table>
          <div class="row"><label><input type="checkbox" id="autoApply" /> Rakenda kuu maksed automaatselt</label></div>
          <div class="divider"></div>
          <button class="btn primary" id="simulate">Simuleeri tasumist</button>
          <div class="kpi" style="margin-top:10px">
            <div class="box"><div class="label">Aeg võlavabaks</div><div class="val mono" id="kpiMonths">—</div></div>
            <div class="box"><div class="label">Esimesena tasutav</div><div class="val mono" id="kpiFirstDone">—</div></div>
            <div class="box"><div class="label">Võlavaba kuupäev</div><div class="val mono" id="kpiDebtFreeDate">—</div></div>
          </div>
          <p class="small muted">Intressi ei arvestata. Kõik miinimumid makstakse; ülejääk suunatakse väikseima jäägiga võlale.</p>
        </div>
      </details>
    </div>

    <!-- 4) Kulutuste jälgija -->
    <div class="card">
      <details open>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>4) Kulutuste jälgija (selle kuu)</h2></div>
          <div class="pill" id="pillSpent">Sel kuul: —</div>
        </summary>
        <div class="content">
          <div class="row">
            <label>Kategooria</label>
            <select id="expCat">
              <option>Zaza</option>
              <option>Toit</option>
              <option>Transport</option>
              <option>Meelelahutus</option>
              <option>Riided/Isiklik</option>
              <option>Muu</option>
            </select>
          </div>
          <div class="row"><label>Summa (€)</label><input id="expAmt" type="number" class="mono" min="0" step="0.01" /></div>
          <div class="row"><label>Kuupäev</label><input id="expDate" type="date" /></div>
          <div class="row"><label>Märkus</label><input id="expNote" type="text" placeholder="mis, kus, kelle jaoks"></div>
          <div class="row"><button class="btn primary" id="addExp">+ Lisa kulu</button></div>

          <div class="divider"></div>
          <table id="expTbl">
            <thead><tr><th>Kuupäev</th><th>Kategooria</th><th>Märkus</th><th class="right">€</th><th></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="3"><strong>Kokku (kuu):</strong></td><td class="right mono" id="expSum">0.00</td><td></td></tr></tfoot>
          </table>

          <div class="divider"></div>
          <h3>Sel kuul kategooriate kaupa</h3>
          <div id="expBreakdown" class="small"></div>
        </div>
      </details>
    </div>
  </section>

  <!-- PAREM VEERG -->
  <section class="grid">
    <!-- Arhiiv (loe‑ainult) -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Arhiiv (varasemad kuud)</h2></div>
        </summary>
        <div class="content">
          <div id="archivesList" class="small"></div>
          <div class="note">Arhiivi kirjed tekivad automaatselt, kui kuu vahetub. Sisaldab kogu eelmise kuu seisu.</div>
        </div>
      </details>
    </div>

    <!-- Psühholoogia -->
    <div class="card">
      <details>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Psühholoogianipid</h2></div>
        </summary>
        <div class="content">
          <h3>Tegevuskavad</h3>
          <textarea id="implIntents">Kui kell on pärast 22:30 ja tekib isu, teen teed ja teen 8-min venituse; kui ikka tahan, jään oma piirangu juurde.</textarea>
          <h3>Tahtmise laine (3 minutit)</h3>
          <div class="row">
            <button class="btn" id="startUrge">Käivita 3:00</button>
            <div id="urgeClock" class="pill mono">03:00</div>
          </div>
          <h3>Nädalane kontroll (10 min)</h3>
          <ul class="small">
            <li>Logi tegelikud kulud eelarvesse.</li>
            <li>Kontrolli kanepi “ümbriku”/alamkontot.</li>
            <li>Kui läheb üle, kärbi sel nädalal (mitte järgmisel kuul).</li>
            <li>Tähista üks võit (nt “€40 → Hädaabifond”).</li>
          </ul>
        </div>
      </details>
    </div>

    <!-- Jooksev kokkuvõte + maksepäevad -->
    <div class="card">
      <details open>
        <summary>
          <div class="sum-left"><span class="chev">▶</span><h2>Jooksev kokkuvõte & maksepäevad</h2></div>
        </summary>
        <div class="content">
          <div id="liveSummary" class="small"></div>
          <div class="divider"></div>
          <h3>Lähenevad maksepäevad (võlad PP)</h3>
          <div id="upcomingPays" class="small"></div>
        </div>
      </details>
    </div>
  </section>
</main>

<script>
  // ===== Abi =====
  const $ = sel => document.querySelector(sel);
  const fmt = n => isFinite(n) ? (Number(n).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})) : '—';
  const fmt2 = n => isFinite(n) ? (Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})) : '—';
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

  // Päis
  const todayDate = $("#todayDate");
  const monthBadge = $("#monthBadge");
  const now = new Date();
  todayDate.textContent = now.toLocaleDateString(undefined,{weekday:'long', year:'numeric', month:'long', day:'numeric'});
  monthBadge.textContent = now.toLocaleDateString(undefined,{month:'long', year:'numeric'});

  // Elemendid
  const inputs = {
    income:      $("#income"),
    loans:       $("#loans"),
    mom:         $("#mom"),
    aptSupport:  $("#aptSupport"),
    phone:       $("#phone"),
    transport:   $("#transport"),
    groceries:   $("#groceries"),
    otherEss:    $("#otherEss"),
    fun:         $("#fun"),
    personal:    $("#personal"),
    zazaCap:     $("#zazaCap"),
    efTarget:    $("#efTarget"),
    efNow:       $("#efNow"),
    pricePerGram:$("#pricePerGram"),
    gramsPerWeek:$("#gramsPerWeek"),
    zazaAuto:    $("#zazaAuto"),
    zazaCutPct:  $("#zazaCutPct"),
    applyCap:    $("#applyCap"),
    autoApply:   $("#autoApply"),
    paydays:     $("#paydaysInput"),
  };

  const kpis = {
    out:   $("#kpiOut"),
    left:  $("#kpiLeft"),
    alloc: $("#kpiAlloc"),
    months:$("#kpiMonths"),
    firstDone:$("#kpiFirstDone"),
    debtFreeDate:$("#kpiDebtFreeDate"),
  };

  const summary = $("#liveSummary");
  const upcomingPays = $("#upcomingPays");
  const pillBudget = $("#pillBudget");
  const pillZaza = $("#pillZaza");
  const pillDebt = $("#pillDebt");
  const pillSpent = $("#pillSpent");
  const zazaProg = $("#zazaProg");
  const archivesList = $("#archivesList");

  // ===== Kuu‑põhine püsivus =====
  const KEY = "rahakask-v5";
  const KEY_EXP = "rahakask-v5-expenses"; // ainult jooksva kuu kulud
  const CUR_MONTH = monthKey(new Date());
  let payMarksCache = null;
  const defaultPayMarks = () => ({supports:{mom:false,aptSupport:false}, debts:{}});
  function readState(){ try{ return JSON.parse(localStorage.getItem(KEY)||"{}"); }catch(e){ return {}; } }
  function writeState(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
  function getPayMarks(){
    if(payMarksCache) return payMarksCache;
    const state = readState();
    state.payMarks = state.payMarks || {};
    const existing = state.payMarks[CUR_MONTH];
    if(existing){
      payMarksCache = {
        supports: Object.assign({mom:false,aptSupport:false}, existing.supports||{}),
        debts: Object.assign({}, existing.debts||{})
      };
    } else {
      payMarksCache = defaultPayMarks();
    }
    state.payMarks[CUR_MONTH] = payMarksCache;
    writeState(state);
    return payMarksCache;
  }
  function savePayMarks(){
    if(!payMarksCache) return;
    const state = readState();
    state.payMarks = state.payMarks || {};
    state.payMarks[CUR_MONTH] = payMarksCache;
    writeState(state);
  }
  function resetPayMarksCache(){ payMarksCache = null; }

  
  
  function archiveIfMonthRolled(){
    const state = readState();
    const cur = monthKey(new Date());
    const storedMonth = (state.meta && state.meta.month) || null;

    const hadMeta = !!storedMonth;
    const monthChanged = hadMeta && storedMonth !== cur;

    state.archives = state.archives || [];
    state.data = state.data || {};

    if (monthChanged){
      // Load all expenses (previous + current) from store
      let allExpenses = [];
      try { allExpenses = JSON.parse(localStorage.getItem(KEY_EXP) || "[]"); } catch (e) { allExpenses = []; }
      const prevMonth = storedMonth; // e.g., "2025-09"
      const prevMonthExpenses = allExpenses.filter(e => String(e.date||"").slice(0,7) === prevMonth);

      // Compute initial carryOver (leftover cash) based on previous month
      const b = (state.data && state.data.budget) || {};
      const income = +b.income || 0;
      const fixedBills = (+b.loans||0) + (+b.mom||0) + (+b.aptSupport||0) + (+b.phone||0);
      const spent = prevMonthExpenses.reduce((s,x)=> s + (+x.amt||0), 0);
      let carryOver = income - fixedBills - spent;
      if (!isFinite(carryOver)) carryOver = 0;
      if (carryOver < 0) carryOver = 0;

      // Prepare debts for update
      const debts = (state.data && state.data.debts ? JSON.parse(JSON.stringify(state.data.debts)) : []);
      const minsPaid = [];
      let minTotalApplied = 0;

      // Auto-apply toggle
      const ds = (state.data && state.data.debtSettings) || {};
      const autoApply = !!ds.autoApply;

      if (autoApply && debts.length){
        // 1) Apply per-debt minimums (reduce balances)
        debts.forEach(d => {
          const before = +d.balance || 0;
          let pay = Math.min(+d.min || 0, before);
          if (pay > 0){
            d.balance = Math.max(0, before - pay);
            minTotalApplied += pay;
            minsPaid.push({name:d.name, amount:pay});
          }
        });

        // Write updated debts back
        state.data.debts = debts;

        // Archive snapshot incl. payments summary
        const archiveEntry = {
          month: prevMonth,
          ts: Date.now(),
          data: state.data || {},
          expenses: prevMonthExpenses,
          carryOver: carryOver,
          payments: {
            mins: minsPaid,
            minsTotal: minTotalApplied
          }
        };
        state.archives.push(archiveEntry);
      } else {
        // No auto-apply: archive without altering debts
        const archiveEntry = {
          month: prevMonth,
          ts: Date.now(),
          data: state.data || {},
          expenses: prevMonthExpenses,
          carryOver: carryOver
        };
        state.archives.push(archiveEntry);
      }

      // Apply carryover to EF balance for the new month
      if (!state.data.budget) state.data.budget = {};
      state.data.budget.efNow = (+state.data.budget.efNow || 0) + carryOver;

      // Clear only expenses (new month starts fresh)
      localStorage.removeItem(KEY_EXP);

      // Reset paid markers for the new month
      state.payMarks = state.payMarks || {};
      state.payMarks[prevMonth] && delete state.payMarks[prevMonth];
      state.payMarks[cur] = defaultPayMarks();
      resetPayMarksCache();
    }

    // Update current meta month
    state.meta = { month: cur };
    writeState(state);
  }
  function renderArchives(){
    const state = readState();
    const list = (state.archives||[]).slice().reverse();
    if (!list.length){ archivesList.innerHTML = "<em>Arhiiv on tühi.</em>"; return; }
    archivesList.innerHTML = list.map(a=>{
      const tot = (a.expenses||[]).reduce((s,x)=>s+(+x.amt||0),0);
      const minsT = a.payments && a.payments.minsTotal || 0;
      const zaza = (a.expenses||[]).filter(x=>x.cat==="Zaza").reduce((s,x)=>s+(+x.amt||0),0);
      const when = new Date(a.ts).toLocaleString();
      const payLine = a.payments ? `<div>Maksed võlgadele (auto): min <strong>€ ${fmt2(minsT)}</strong></div>` : `<div>Auto-makseid ei tehtud.</div>`;
      return `<div class="archiveItem">
        <div><strong>${a.month}</strong> — arhiveeritud: ${when}</div>
        <div>Kulud kokku: <strong>€ ${fmt2(tot)}</strong>; Zaza: <strong>€ ${fmt2(zaza)}</strong></div>
        ${payLine}
        <div>Ülejääk EF-i: <strong>€ ${fmt2(a.carryOver||0)}</strong></div>
        <div class="small muted">Kirje sisaldab kogu kuu seisu (eelarve, võlad, sätted) ja kõiki kulusid.</div>
      </div>`;
    }).join("");
  }

  function reflectSupportPaid(key){
    const marks = getPayMarks();
    const paid = !!(marks.supports && marks.supports[key]);
    const btn = document.querySelector(`[data-pay-support="${key}"]`);
    if(btn){
      btn.textContent = paid ? "Makstud ✓" : "Märgi makstuks";
      btn.classList.toggle("paid", paid);
      const row = btn.closest(".row");
      if(row) row.classList.toggle("is-paid", paid);
    }
  }
  function toggleSupportPaid(key){
    const marks = getPayMarks();
    marks.supports = marks.supports || {mom:false,aptSupport:false};
    marks.supports[key] = !marks.supports[key];
    savePayMarks();
    reflectSupportPaid(key);
  }
  let supportButtonsInit=false;
  function refreshSupportButtons(){
    document.querySelectorAll('[data-pay-support]').forEach(btn=>{
      const key=btn.getAttribute('data-pay-support');
      reflectSupportPaid(key);
    });
  }
  function initSupportButtons(){
    if(!supportButtonsInit){
      document.querySelectorAll('[data-pay-support]').forEach(btn=>{
        const key=btn.getAttribute('data-pay-support');
        btn.addEventListener('click',()=>{ toggleSupportPaid(key); });
      });
      supportButtonsInit=true;
    }
    refreshSupportButtons();
  }
  function reflectDebtPaid(id){
    const marks = getPayMarks();
    const paid = !!(marks.debts && marks.debts[id]);
    const row = debtsTbl.querySelector(`tr[data-id="${id}"]`);
    if(row){
      row.classList.toggle("paid", paid);
      const btn = row.querySelector("[data-pay-debt]");
      if(btn){
        btn.textContent = paid ? "Makstud ✓" : "Märgi makstuks";
        btn.classList.toggle("paid", paid);
      }
    }
  }
  function toggleDebtPaid(id){
    const marks = getPayMarks();
    marks.debts = marks.debts || {};
    marks.debts[id] = !marks.debts[id];
    savePayMarks();
    reflectDebtPaid(id);
  }
  function clearDebtPaid(id){
    const marks = getPayMarks();
    if(marks.debts && marks.debts[id]){
      delete marks.debts[id];
      savePayMarks();
    }
  }

  // ===== Payday helperid =====
  function parsePaydays(txt){
    if (!txt) return [];
    return String(txt).split(/[,\s]+/).map(s=>parseInt(s,10)).filter(n=>Number.isInteger(n)&&n>=1&&n<=31).sort((a,b)=>a-b);
  }
  function nextDatesFromDays(dayList, from=new Date(), count=3){
    if (!dayList.length) return [];
    const results=[]; let d=new Date(from); d.setHours(12,0,0,0);
    while(results.length<count){
      for(const dd of dayList){
        const y=d.getFullYear(), m=d.getMonth();
        const last=new Date(y,m+1,0).getDate();
        let cand=new Date(y,m,Math.min(dd,last)); cand.setHours(12,0,0,0);
        if(cand<d){ const nm=new Date(y,m+1,1); const last2=new Date(nm.getFullYear(),nm.getMonth()+1,0).getDate(); cand=new Date(nm.getFullYear(),nm.getMonth(),Math.min(dd,last2)); }
        results.push(cand); if(results.length>=count) break;
      }
      d=new Date(results[results.length-1].getTime()+86400000);
    }
    results.sort((a,b)=>a-b);
    const uniq=[]; for(const dt of results){ if(!uniq.length||(+dt!==+uniq[uniq.length-1])) uniq.push(dt); if(uniq.length===count) break; }
    return uniq.slice(0,count);
  }
  function daysBetween(a,b){
    const A=new Date(a.getFullYear(),a.getMonth(),a.getDate());
    const B=new Date(b.getFullYear(),b.getMonth(),b.getDate());
    return Math.ceil((B-A)/86400000);
  }
  function updatePayInfo(){
    const el=inputs.paydays, info=$("#nextPayInfo");
    if(!el||!info) return;
    const days=parsePaydays(el.value);
    if(!days.length){ info.innerHTML="<em>Lisa palgapäeva päev (nt 5 või 5,20).</em>"; return; }
    const next3=nextDatesFromDays(days,new Date(),3);
    const fmtOpts={day:'2-digit',month:'long',year:'numeric'};
    const today=new Date();
    info.innerHTML = next3.map(d=>`• ${d.toLocaleDateString(undefined,fmtOpts)} — <strong>${daysBetween(today,d)} päeva</strong>`).join("<br>");
  }

  // ===== Eelarve =====
  function computeOutflows(){
    const essentials=(+inputs.loans.value||0)+(+inputs.mom.value||0)+(+inputs.aptSupport.value||0)+(+inputs.phone.value||0)+(+inputs.transport.value||0)+(+inputs.groceries.value||0)+(+inputs.otherEss.value||0);
    const discretionary=(+inputs.fun.value||0)+(+inputs.personal.value||0)+(+inputs.zazaCap.value||0);
    return essentials+discretionary;
  }
  function recomputeBudget(){
    const income=+inputs.income.value||0;
    const out=computeOutflows();
    const left=income-out;
    let toEF=0;
    const efNeed=Math.max(0,(+inputs.efTarget.value||0)-(+inputs.efNow.value||0));
    if(left>0){ toEF=Math.min(left,efNeed); }
    const freeCash = left>0 ? Math.max(0,left-toEF) : 0;
    kpis.out.textContent="€ "+fmt(out);
    kpis.left.textContent=(left>=0?"€ "+fmt(left):"€ -"+fmt(Math.abs(left)));
    kpis.left.className="val mono "+(left>0?"good":(left===0?"":"bad"));
    kpis.alloc.textContent=`Hädaabifond € ${fmt(toEF)}  |  Ülejääk € ${fmt(freeCash)}`;
    pillBudget.textContent=`Ülejääk: € ${fmt(left)}`;
    // pillDebt uuendatakse simulatsiooni põhjal
    summary.innerHTML=`<div>Sissetulek: <strong>€ ${fmt(income)}</strong></div>
      <div>Plaanitud väljavool: <strong>€ ${fmt(out)}</strong></div>
      <div>Ülejääk: <strong class="${left>0?'good':(left===0?'':'bad')}">€ ${fmt(left)}</strong></div>
      <div>Jaotus sel kuul → Hädaabifond: <strong>€ ${fmt(toEF)}</strong>; Alles jääb: <strong>€ ${fmt(freeCash)}</strong></div>`;
    refreshZazaLeft();
  }

  // ===== Kanepi kalkulaator =====
  const capMsg=$("#capMsg");
  function recomputeZaza(){
    const monthly=(+inputs.pricePerGram.value||0)*(+inputs.gramsPerWeek.value||0)*4.3;
    inputs.zazaAuto.value=(isFinite(monthly)? monthly.toFixed(0):"");
    return monthly;
  }
  if(inputs.applyCap){
    inputs.applyCap.addEventListener("click",()=>{
      const monthly=recomputeZaza();
      const cutPct=clamp(+inputs.zazaCutPct.value||0,0,100);
      const newCap=Math.round(monthly*(1-cutPct/100));
      const savings=Math.max(0,Math.round(monthly-newCap));
      inputs.zazaCap.value=newCap;
      const efNeed=Math.max(0,(+inputs.efTarget.value||0)-(+inputs.efNow.value||0));
      if(capMsg) capMsg.textContent=`Ülempiir €${fmt(newCap)}. Sääst €${fmt(savings)} suunatud EF-i (vajadus €${fmt(efNeed)}).`;
      recomputeBudget(); persist();
    });
  }

  // ===== Võlaplaan =====
  const debtsTbl=$("#debtsTbl tbody");
  const sumBal=$("#sumBal");
  const sumMin=$("#sumMin");
  function addDebtRow(d={name:"Laen",balance:0,min:0,due:"",notes:"",id:null}){
    const tr=document.createElement("tr");
    const rowId=d.id||`d-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
    tr.dataset.id=rowId;
    tr.innerHTML=`
      <td><input value="${d.name||''}" /></td>
      <td class="right"><input type="number" class="mono" value="${d.balance||0}" step="1" min="0" /></td>
      <td class="right"><input type="number" class="mono" value="${d.min||0}" step="1" min="0" /></td>
      <td><input value="${d.due||''}" placeholder="PP" /></td>
      <td><input value="${d.notes||''}" /></td>
      <td><button class="btn payToggle" data-pay-debt="${rowId}">Märgi makstuks</button></td>
      <td><button class="btn" data-action="remove">✕</button></td>`;
    const removeBtn=tr.querySelector('[data-action="remove"]');
    if(removeBtn){
      removeBtn.addEventListener("click",()=>{ tr.remove(); clearDebtPaid(rowId); updateDebtTotals(); persist(); renderUpcomingPays(); simulatePayoff(); });
    }
    tr.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",()=>{ updateDebtTotals(); persist(); renderUpcomingPays(); simulatePayoff(); }));
    const payBtn=tr.querySelector(`[data-pay-debt="${rowId}"]`);
    if(payBtn){
      payBtn.addEventListener("click",()=>{ toggleDebtPaid(rowId); });
    }
    debtsTbl.appendChild(tr); updateDebtTotals(); renderUpcomingPays(); simulatePayoff();
    reflectDebtPaid(rowId);
  }
  function readDebts(){
    return [...debtsTbl.querySelectorAll("tr")].map(r=>{
      const [name,balance,min,due,notes]=[...r.querySelectorAll("input")].map(x=>x.value);
      const id=r.dataset.id||"";
      return {id, name, balance:+balance||0, min:+min||0, due, notes};
    });
  }
  function updateDebtTotals(){
    const d=readDebts();
    sumBal.textContent=fmt(d.reduce((a,b)=>a+b.balance,0));
    sumMin.textContent=fmt(d.reduce((a,b)=>a+b.min,0));
  }
  $("#addDebt").addEventListener("click",()=>addDebtRow());
  function simulatePayoff(){
    const debts=readDebts().filter(d=>d.balance>0).map(d=>({...d}));
    if(!debts.length){
      kpis.months.textContent="—";
      kpis.firstDone.textContent="—";
      kpis.debtFreeDate.textContent="—";
      pillDebt.textContent="Esimesena tasutav: —";
      return;
    }
    const nextTarget = debts.slice().sort((a,b)=>a.balance-b.balance).find(d=>d.balance>0);
    let month=0, firstDone=null;
    const sort=()=>debts.sort((a,b)=>a.balance-b.balance); sort();
    let snowballExtra = 0;
    while(debts.some(d=>d.balance>0)&&month<600){
      month++;
      debts.forEach(d=>{ if(d.balance<=0) return; d.balance-=Math.min(d.min,d.balance); });
      let monthExtra = snowballExtra;
      debts.forEach(d=>{
        if(d.balance>0&&d.balance<0.01) d.balance=0;
        if(d.balance===0&&!d._done){
          d._done=true;
          snowballExtra += d.min;
          monthExtra += d.min;
          if(!firstDone) firstDone={name:d.name,month};
        }
      });
      sort();
      while(monthExtra>0){
        const target=debts.find(d=>d.balance>0);
        if(!target) break;
        const pay=Math.min(monthExtra,target.balance);
        target.balance-=pay;
        monthExtra-=pay;
        if(target.balance>0&&target.balance<0.01) target.balance=0;
        if(target.balance===0&&!target._done){
          target._done=true;
          snowballExtra += target.min;
          monthExtra += target.min;
          if(!firstDone) firstDone={name:target.name,month};
        }
        sort();
      }
    }
    const years=Math.floor(month/12), mRem=month%12;
    kpis.months.textContent= month? (years? `${years} a ${mRem} k`:`${month} k`) :"—";
    kpis.firstDone.textContent= firstDone? `${firstDone.name} → ${firstDone.month}. kuu` :"—";
    const debtFree=new Date(); debtFree.setMonth(debtFree.getMonth()+month);
    kpis.debtFreeDate.textContent=debtFree.toLocaleDateString(undefined,{day:'2-digit',month:'long',year:'numeric'});
    pillDebt.textContent = `Esimesena tasutav: ${nextTarget ? nextTarget.name : '—'}`;
  }
  $("#simulate").addEventListener("click",simulatePayoff);

  $("#exportDebtCsv").addEventListener("click",()=>{
    const debts=readDebts();
    let csv="Võlg,Jääk,Miinimum,Tähtaeg (PP),Märkused\n";
    debts.forEach(d=>{ csv+=`"${d.name}",${d.balance},${d.min},"${d.due}","${(d.notes||'').replace(/"/g,'""')}"\n`; });
    const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download="volgade_loetelu.csv"; a.click();
  });

  // ===== Tahtmise taimer =====
  const startUrge=$("#startUrge"); const urgeClock=$("#urgeClock"); let urgeTimer=null;
  if(startUrge){ startUrge.addEventListener("click",()=>{ if(urgeTimer){clearInterval(urgeTimer); urgeTimer=null;} let secs=180; if(urgeClock) urgeClock.textContent="03:00";
    urgeTimer=setInterval(()=>{ secs--; if(secs<=0){clearInterval(urgeTimer); urgeTimer=null; if(urgeClock) urgeClock.textContent="Valmis ✓"; return;}
      const m=String(Math.floor(secs/60)).padStart(2,"0"); const s=String(secs%60).padStart(2,"0"); if(urgeClock) urgeClock.textContent=`${m}:${s}`; },1000);
  });}

  // ===== Kulutuste jälgija =====
  const expTblBody=$("#expTbl tbody"); const expSum=$("#expSum"); const expBreakdown=$("#expBreakdown");
  const expCat=$("#expCat"); const expAmt=$("#expAmt"); const expDate=$("#expDate"); const expNote=$("#expNote"); const addExp=$("#addExp");
  function todayISO(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
  if(expDate) expDate.value=todayISO();

  function readExpenses(){ try{ return JSON.parse(localStorage.getItem(KEY_EXP)||"[]"); }catch(e){ return []; } }
  function writeExpenses(list){ localStorage.setItem(KEY_EXP, JSON.stringify(list)); }
  function addExpenseRow(e, idx){
    const tr=document.createElement("tr"); const when=new Date(e.date);
    tr.innerHTML=`<td>${isFinite(when)? when.toLocaleDateString():e.date}</td><td>${e.cat}</td><td>${e.note? e.note.replace(/</g,'&lt;'):''}</td><td class="right mono">${fmt2(e.amt)}</td><td><button class="btn" data-i="${idx}">✕</button></td>`;
    tr.querySelector("button").addEventListener("click",(ev)=>{ const i=+ev.currentTarget.getAttribute("data-i"); const all=readExpenses(); all.splice(i,1); writeExpenses(all); renderExpenses(); persist(); });
    expTblBody.appendChild(tr);
  }
  function renderExpenses(){
    const all=readExpenses(); const mk=monthKey(new Date());
    const monthList=all.filter(e=> (e.date||"").slice(0,7)===mk);
    expTblBody.innerHTML=""; monthList.forEach((e,i)=> addExpenseRow(e, readExpenses().indexOf(e)));
    const total=monthList.reduce((a,b)=>a+(+b.amt||0),0); expSum.textContent=fmt2(total);
    const byCat={}; monthList.forEach(e=> byCat[e.cat]=(byCat[e.cat]||0)+(+e.amt||0));
    expBreakdown.innerHTML = Object.entries(byCat).map(([c,v])=>`<div>• ${c}: <strong>€ ${fmt2(v)}</strong></div>`).join("") || "<em>Sel kuul kulusid pole.</em>";
    pillSpent.textContent=`Sel kuul: € ${fmt2(total)}`; refreshZazaLeft();
  }
  if(addExp){ addExp.addEventListener("click",()=>{
      const e={ cat: expCat.value, amt:+expAmt.value||0, date: expDate.value||todayISO(), note: expNote.value||"" };
      if(!e.amt){ alert("Sisesta summa."); return; } const all=readExpenses(); all.push(e); writeExpenses(all);
      expAmt.value=""; expNote.value=""; renderExpenses(); persist();
  });}

  function refreshZazaLeft(){
    const cap=+inputs.zazaCap.value||0; const all=readExpenses(); const mk=monthKey(new Date());
    const zazaSpent=all.filter(e=> (e.date||"").slice(0,7)===mk && e.cat==="Zaza").reduce((a,b)=>a+(+b.amt||0),0);
    const left=Math.max(0, cap-zazaSpent); pillZaza.textContent=`Zaza alles: € ${fmt2(left)}`;
    const usedPct=cap>0? Math.max(0,Math.min(100,(zazaSpent/cap)*100)):0;
    if(zazaProg){ zazaProg.style.width=usedPct+"%"; zazaProg.style.background= usedPct>100?"var(--bad)":(usedPct>90?"var(--warn)":"var(--accent)"); }
  }

  // ===== Persist + rakenduse laadimine =====
  function collectData(){
    return {
      budget:{
        income:+inputs.income.value||0, loans:+inputs.loans.value||0, mom:+inputs.mom.value||0, aptSupport:+inputs.aptSupport.value||0,
        phone:+inputs.phone.value||0, transport:+inputs.transport.value||0, groceries:+inputs.groceries.value||0, otherEss:+inputs.otherEss.value||0,
        fun:+inputs.fun.value||0, personal:+inputs.personal.value||0, zazaCap:+inputs.zazaCap.value||0, efTarget:+inputs.efTarget.value||0, efNow:+inputs.efNow.value||0
      },
      cannabis:{ price:+inputs.pricePerGram.value||0, grams:+inputs.gramsPerWeek.value||0, cutPct:+inputs.zazaCutPct.value||0 },
      debtSettings:{
        autoApply: !!(inputs.autoApply && inputs.autoApply.checked)
      },
      debts: readDebts(),
      user:{ paydays: (inputs.paydays||{}).value || "" },
      psych:{ impl: ($("#implIntents")||{}).value || "" }
    };
  }
  function applyData(d){
    if(d.budget){ for(const k in d.budget){ if(inputs[k]&&typeof d.budget[k]!=="undefined") inputs[k].value=d.budget[k]; } }
    if(d.cannabis){ inputs.pricePerGram.value=d.cannabis.price||0; inputs.gramsPerWeek.value=d.cannabis.grams||0; inputs.zazaCutPct.value=d.cannabis.cutPct||0; }
    if(d.debtSettings){
      if(inputs.autoApply) inputs.autoApply.checked=!!d.debtSettings.autoApply;
    }
    if(d.debts){ debtsTbl.innerHTML=""; d.debts.forEach(addDebtRow); }
    if(d.user&&inputs.paydays){ inputs.paydays.value=d.user.paydays||""; }
    if(d.psych&&$("#implIntents")){ $("#implIntents").value=d.psych.impl||""; }
  }
  function persist(){ const state=readState(); state.data=collectData(); writeState(state); }

  function load(){
    archiveIfMonthRolled();
    initSupportButtons();
    const state=readState(); applyData(state.data||{});
    // init
    recomputeZaza(); recomputeBudget(); renderExpenses(); renderUpcomingPays(); updatePayInfo(); simulatePayoff(); renderArchives();
    // default debts if none
    if(!state.data || !state.data.debts || !state.data.debts.length){
      addDebtRow({name:"Kaart A", balance:1200, min:50, due:"15"});
      addDebtRow({name:"Laen B", balance:2000, min:70, due:"28"});
      persist();
    }
  }

  document.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", ()=>{
      if(el===inputs.pricePerGram || el===inputs.gramsPerWeek){ recomputeZaza(); }
      if(["income","loans","mom","aptSupport","phone","transport","groceries","otherEss","fun","personal","zazaCap","efTarget","efNow"].includes(el.id)){ recomputeBudget(); }
      if(el===inputs.paydays){ updatePayInfo(); }
      persist();
    });
  });

  // ===== Võlgade maksepäevad (PP) =====
  function nextDueDate(dayStr){
    const dd=parseInt(dayStr,10); if(!dd||dd<1||dd>31) return null;
    const t=new Date(); const y=t.getFullYear(); const m=t.getMonth(); let cand=new Date(y,m,dd);
    const today=new Date(y,m,t.getDate());
    if(cand<today){ const nmY=m===11?y+1:y; const nmM=(m+1)%12; const last=new Date(nmY,nmM+1,0).getDate(); cand=new Date(nmY,nmM,Math.min(dd,last)); }
    else { const last=new Date(y,m+1,0).getDate(); cand=new Date(y,m,Math.min(dd,last)); }
    return cand;
  }
  function renderUpcomingPays(){
    const debts=readDebts();
    const list=debts.map(d=>({name:d.name, date: nextDueDate(d.due)})).filter(x=>x.date);
    list.sort((a,b)=>a.date-b.date);
    if(!list.length){ upcomingPays.innerHTML="<em>Lisa võlgadele tähtaeg (PP), nt 15.</em>"; return; }
    const fmtOpt={day:'2-digit',month:'long',year:'numeric'};
    upcomingPays.innerHTML=list.map(x=>`<div>• ${x.name}: <strong>${x.date.toLocaleDateString(undefined,fmtOpt)}</strong></div>`).join("");
  }

  // Käivitus
  load();
</script>
</body>
</html>
